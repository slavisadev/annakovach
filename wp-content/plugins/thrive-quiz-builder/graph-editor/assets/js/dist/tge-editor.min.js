/*! Thrive Graph Editor - 2022-01-25
* http://www.thrivethemes.com/
* Copyright (c) 2022 Thrive Themes */

var TGE_Editor=TGE_Editor||{};TGE_Editor.models=TGE_Editor.models||{},TGE_Editor.collections=TGE_Editor.collections||{},TGE_Editor.default_video_options=TGE_Editor.default_video_options||{},TGE_Editor.default_audio_options=TGE_Editor.default_audio_options||{},TGE_Editor.default_text_options=TGE_Editor.default_text_options||{},TGE_Editor.default_video_style=TGE_Editor.default_video_style||{},function(a){Backbone.emulateHTTP=!0,Backbone.Collection.prototype.save=function(a){Backbone.sync("update",this,a)},TGE_Editor.models.Base=Backbone.Model.extend({defaults:{},toDeepJSON:function(){var b=a.extend(!0,{},this.attributes);return _.each(_.keys(b),function(a){_.isUndefined(b[a])||_.isNull(b[a])||!_.isFunction(b[a].toJSON)||(b[a]=b[a].toJSON())}),b},validation_error:function(a,b,c){return{field:a,message:b,callback:c}},url:function(b){return b=b||{},b=_.extend({},b,{action:TGE_Editor.ajax_controller_action,_nonce:TGE_Editor.nonce}),TGE_Editor.ajaxurl+"?"+a.param(b)},sync:function(a,b,c){return this.beforeSync(),Backbone.sync(a,b,c)},beforeSync:function(){return this}}),TGE_Editor.models.Question=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{quiz_id:TGE_Editor.quiz.ID,text:"",position:{x:100,y:100},display_type_labels:{0:TGE_Editor.t.type_text,1:TGE_Editor.t.type_video,2:TGE_Editor.t.type_audio},video_source:"youtube",display_settings:{display_type:0,default_video:TGE_Editor.default_video,video_style:{selected:0,labels:{0:TGE_Editor.t.video_style_no_style,1:TGE_Editor.t.video_style_gray_monitor,2:TGE_Editor.t.video_style_black_monitor,3:TGE_Editor.t.video_style_black_tablet,4:TGE_Editor.t.video_style_white_tablet,5:TGE_Editor.t.video_style_white_frame,6:TGE_Editor.t.video_style_gray_frame,7:TGE_Editor.t.video_style_dark_frame,8:TGE_Editor.t.video_style_light_frame,9:TGE_Editor.t.video_style_lifted_style1,10:TGE_Editor.t.video_style_lifted_style2,11:TGE_Editor.t.video_style_lifted_style3,12:TGE_Editor.t.video_style_lifted_style4,13:TGE_Editor.t.video_style_lifted_style5,14:TGE_Editor.t.video_style_lifted_style6}},type:"text",source:"youtube",audio_source:"custom",source_labels:{youtube:TGE_Editor.t.video_source_youtube,vimeo:TGE_Editor.t.video_source_vimeo,wistia:TGE_Editor.t.video_source_wistia,custom:TGE_Editor.t.video_source_custom},source_audio_labels:{spotify:TGE_Editor.t.audio_source_spotify,soundcloud:TGE_Editor.t.audio_source_soundcloud,custom:TGE_Editor.t.video_source_custom},url:"",color:"#0FACF2",options:{},new_question:1}}),initialize:function(a){null===this.get("display_settings")&&this.set("display_settings",this.defaults.display_settings);var b=[];a&&a.image&&this.set("image",new TGE_Editor.models.Image(a.image)),a&&a.answers?(b=new TGE_Editor.collections.Answers(a.answers,{q_type:this.get_type_key()}),this.set("answers",b)):(b=new TGE_Editor.collections.Answers([]),this.set("answers",b)),this.set("settings",new TGE_Editor.models.QuestionSettings(a&&a.settings?a.settings:void 0))},set:function(a,b,c){return"string"==typeof a&&this.get("settings")instanceof Backbone.Model&&0===a.indexOf("settings.")?(this.get("settings").set(a,b,c),this):Backbone.Model.prototype.set.apply(this,arguments)},get_type_key:function(){return 1==this.get("q_type")?"button":"image"},parse:function(a){if(a.answers=new TGE_Editor.collections.Answers(a.answers||[]),a.image&&(a.image=new TGE_Editor.models.Image(a.image)),a.settings&&(a.settings=new TGE_Editor.models.QuestionSettings(a.settings)),void 0!==a.display_settings){var b="Text";if(a.display_settings instanceof Backbone.Model)switch(a.display_settings.get("display_type")){case 0:default:display_settings.type="text",b="Text";break;case 1:display_settings.type="video",b="Video";break;case 2:display_settings.type="audio",b="Audio"}a.display_settings="function"==typeof TGE_Editor.models[b]?new TGE_Editor.models[b](a.display_settings):new Backbone.Model(a.display_settings)}return a},validate:function(){var b=[];if(!this.get("text")||0===this.get("text").length)return b.push(this.validation_error("text",TGE_Editor.t.question_text_required)),b;var c=!0;if(this.get("answers").each(function(a,b,d){if(c){var e=this.factory_answer(a.toJSON());e.isValid()||(c=!1,a.trigger("invalid",a,e.validationError))}},this),!c)return[];!1===this.isOpenEndedType()&&!b.length&&this.get("answers")instanceof Backbone.Collection&&this.get("answers").length<1&&(b=TGE_Editor.t.insufficient_answers),this.isOpenEndedType()&&!1===this.get("settings").isValid()&&(b=a.merge(b,this.get("settings").validationError)),"video"===this.get("type")&&this.get("display_settings")instanceof Backbone.Model&&this.get("displaY_setting").validate(b);var d=this.get("display_settings"),e=[],f=this.changedAttributes();return!!(!f||"undefined"===f.position)&&d instanceof TGE_Editor.models.Video&&(e=d.validate())&&e.length&&b.push(e),b.length?b:void 0},factory_answer:function(a){var b=TGE_Editor.globals.question_types.findWhere({id:parseInt(this.get("q_type"))});if(!b)return new TGE_Editor.models.Answer(a);var c="Answer";return c+=TVE_Dash.upperFirst(b.get("key")),new TGE_Editor.models[c](a)},url:function(){var a={route:"question"};return this.get("id")&&(a.id=this.get("id")),TGE_Editor.models.Base.prototype.url.call(this,a)},clear_for_duplicate:function(){this.attributes.id="",delete this.attributes.rendered,delete this.attributes.level,delete this.attributes.start,this.attributes.next_question_id=null,this.attributes.previous_question_id=null,this.attributes.views=0,this.attributes.position={x:20+this.attributes.position.x,y:20+this.attributes.position.y},this.attributes.answers.each(function(a,b,c){a.clear_for_duplicate()})},isType:function(a){var b=isNaN(a)?{key:a}:{id:parseInt(a)},c=TGE_Editor.globals.question_types.findWhere(b);return c instanceof Backbone.Model&&parseInt(this.get("q_type"))===parseInt(c.get("id"))},isOpenEndedType:function(){return this.isType(3)},isImageType:function(){return this.isType(2)},isButtonType:function(){return this.isType(1)},pushOpenEndedAnswer:function(){var a=this.get("answers");if(this.isOpenEndedType()&&a&&0===a.length)var b=this.get("answers").add(b);return this},beforeSync:function(){this.isOpenEndedType()&&this.get("answers").each(function(a){a.set({points:0},{silent:!0})})},display_feedback:function(){var a=this.get("id")?!0===this.get("settings").get("display_question_feedback"):TGE_Editor.globals.settings.get_model("display_feedback").get("value");return!0===TGE_Editor.globals.display_feedback()&&a},resetDisplaySettings:function(){var a=Object.assign({},this.defaults.display_settings);delete a.type,this.set("display_settings",a)}}),TGE_Editor.collections.Questions=Backbone.Collection.extend({model:TGE_Editor.models.Question}),TGE_Editor.models.Answer=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{text:"",points:1}),initialize:function(a){a&&a.image&&this.set("image",new TGE_Editor.models.Image(a.image))},validate:function(){var a=[];return this.get("points").length<=0&&a.push(this.validation_error("points","personality"!==TGE_Editor.quiz.quiz_type?TGE_Editor.t.answer_points_required:TGE_Editor.t.answer_weight_required)),this.get("points")&&(isNaN(this.get("points"))||this.get("points")%1!=0)&&a.push(this.validation_error("points",null,function(a){a.attr("data-position","bottom"),a.attr("data-tooltip",TGE_Editor.t.points_input_number),a.attr("data-class","tvd-red"),a.addClass("tvd-tooltipped"),a.removeClass("tvd-validate"),a.trigger("mouseenter.tooltip")})),a.length?a:a.length?a:void 0},clear_for_duplicate:function(){delete this.attributes.id,delete this.attributes.next_question_id,delete this.attributes.question_id,this.get("image")instanceof TGE_Editor.models.Image&&this.set("image",new TGE_Editor.models.Image(this.get("image").toJSON().attributes))}}),TGE_Editor.models.AnswerImage=TGE_Editor.models.Answer.extend({defaults:_.extend({},TGE_Editor.models.Answer.prototype.defaults,{image:""}),initialize:function(){TGE_Editor.models.Answer.prototype.initialize.apply(this,arguments)},validate:function(){var a=TGE_Editor.models.Answer.prototype.validate.apply(this,arguments)||[];if(this.get("image")&&0!==this.get("image").length||a.push(this.validation_error("image",null,function(a){a.attr("data-position","bottom"),a.attr("data-tooltip",TGE_Editor.t.answer_image_required),a.attr("data-class","tvd-red"),a.addClass("tvd-tooltipped"),a.trigger("mouseenter.tooltip")})),a.length)return a}}),TGE_Editor.models.Image=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{sizes:{thumbnail:{url:null}}}),initialize:function(a){"string"==typeof a&&this.set(_.extend({},this.defaults,{sizes:{full:{url:a},thumbnail:{url:a}},url:a}))},get_thumb:function(){return this.attributes.sizes.thumbnail?this.attributes.sizes.thumbnail.url||this.get("url")||null:this.get("url")||null}}),TGE_Editor.models.Media=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{display_type:0,type:"",source:"",url:"",color:"",style:"",options:[]}),buildEmbedCode:function(){if(this.attributes.url){var a=this.videoIdAndParams();a&&this.set("video_id",a)}},reset:function(){}}),TGE_Editor.models.Video=TGE_Editor.models.Media.extend({defaults:_.extend({},TGE_Editor.models.Media.prototype.defaults,{video_id:"",style:{},thumb:"",source:"youtube",url:"",options:{autoplay:{id:"autoplay",label:TGE_Editor.t.autoplay,value:1},disable_playbar:{id:"disable_playbar",label:TGE_Editor.t.disable_playbar,value:1}},players:{youtube:{autoplay:"autoplay",hide_logo:"modestbranding",optimize_related:"rel",hide_controls:"controls",hide_full_screens:"fs"},vimeo:{autoplay:"autoplay",disable_playbar:"controls"},wistia:{autoplay:"autoplay",disable_playbar:"playbar",hide_full_screens:"fullscreenButton"},custom:{}}}),initialize:function(a){this.get("thumb")&&(this.set("thumb",new TGE_Editor.models.Image(this.get("thumb"))),this.set("show_thumb",1)),this.set("options",this.getOptions()),this.buildEmbedCode()},allowedMimeTypes:{asf:"video/x-ms-asf",asx:"video/x-ms-asf",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wm:"video/x-ms-wm",avi:"video/avi",divx:"video/divx",flv:"video/x-flv",mov:"video/quicktime",qt:"video/quicktime",mpeg:"video/mpeg",mpg:"video/mpeg",mpe:"video/mpeg",mp4:"video/mp4",m4v:"video/mp4",ogv:"video/ogg",webm:"video/webm",mkv:"video/x-matroska"},getSource:function(){return this.get("source")},hasOption:function(a){return!!this.getMediaOptionsBySource(this.get("source"))[a]},getMediaOptionsBySource:function(a){var b={};switch(a){case"youtube":b={autoplay:{id:"autoplay",label:TGE_Editor.t.autoplay,value:0},hide_logo:{id:"hide_logo",label:TGE_Editor.t.hide_logo,value:1},optimize_related:{id:"optimize_related",label:TGE_Editor.t.optimize_related,value:0},hide_controls:{id:"hide_controls",label:TGE_Editor.t.hide_controls,value:0},hide_full_screens:{id:"hide_full_screens",label:TGE_Editor.t.hide_full_screens,value:0}};break;case"vimeo":b={autoplay:{id:"autoplay",label:TGE_Editor.t.autoplay,value:0},disable_playbar:{id:"disable_playbar",label:TGE_Editor.t.disable_playbar,value:0},hide_full_screens:{id:"hide_full_screens",label:TGE_Editor.t.hide_full_screens_wistia,value:0}};case"wistia":b={autoplay:{id:"autoplay",label:TGE_Editor.t.autoplay,value:0},disable_playbar:{id:"disable_playbar",label:TGE_Editor.t.disable_playbar,value:0},hide_full_screens:{id:"hide_full_screens",label:TGE_Editor.t.hide_full_screens_wistia,value:0}};break;case"custom":b={autoplay:{id:"autoplay",label:TGE_Editor.t.autoplay,value:0},hide_controls:{id:"hide_controls",label:TGE_Editor.t.hide_controls,value:0},loop:{id:"loop",label:TGE_Editor.t.loop,value:0}}}return b},setDefaults:function(){this.attributes.source="youtube"},buildEmbedCode:function(){if(this.attributes.url){var a=this.videoIdAndParams();a&&this.set("video_id",a)}},videoIdAndParams:function(){var a="";switch(this.attributes.source){case"youtube":var b=this.attributes.url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/);a=b&&11==b[7].length?b[7]:"";break;case"vimeo":case"wistia":a=this.attributes.url.substring(this.attributes.url.lastIndexOf("/")+1)}return a=this.buildVideoParams(a)},buildVideoParams:function(a){var b=void 0!==this.attributes.options?this.attributes.options:[],c=void 0!==this.attributes.players?this.attributes.players:[],d=this.attributes.source,e=this.attributes.color?this.attributes.color.replace("#",""):"ffffff",f=[];if("vimeo"===d&&(f.push("color="+this.attributes.color.replace("#","")),f.push("muted=1")),"wistia"===d&&(f.push("chromeless=false"),f.push("controlsVisibleOnLoad=true"),f.push("playerColor="+e),f.push("muted=true")),"youtube"===d){var g=b&&b.hide_logo&&1===parseInt(b.hide_logo.value)?1:0;f.push("mute=1"),f.push("modestbranding="+g)}return _.each(c[d],function(a,c){var e=c,g=a,h=void 0!==b[e]?b[e].value:"0";switch(c){case"autoplay":"youtube"!==d&&"wistia"!==d&&"vimeo"!==d||(h=1===parseInt(h)?"true":"false");break;case"hide_logo":case"hide_controls":h=1===parseInt(h)?0:1;break;case"hide_full_screens":h=1===parseInt(h)?0:1,"wistia"===d&&(h=1===parseInt(h)?"true":"false");break;case"disable_playbar":h=1===parseInt(h)?0:1,"wistia"!==d&&"vimeo"!==d||(h=1===parseInt(h)?"true":"false")}"youtube"===d&&"hide_logo"===c||f.push(g+"="+h)}),"wistia"===d&&f.push("videoFoam=true"),f.length>1?a+="?"+f.join("&"):a},valid_bind_url:function(a){var b=!!this.validateUrlBySource(a);return this.trigger(b?"tge:video:valid:url":"tge:video:invalid:url",this),b},validateUrlBySource:function(a){var b=a||this.attributes.url,c=!1,d="validate"+TVE_Dash.upperFirst(this.attributes.source)+"Url";return"function"==typeof this[d]&&(c=this[d](b)),c},validate:function(){var a=[];return this.validateUrlBySource()?a.length?a:void 0:(this.trigger("tge:video:invalid:url",this),a.push(this.validation_error("url",TVE_Dash.sprintf(TGE_Editor.t.media_url_required,[this.get("type")]))),a)},validation_error:function(a,b,c){return{field:a,message:b,callback:c}},validateYoutubeUrl:function(a){if(void 0!=a||""!=a){var b=a.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|\?v=)([^#\&\?]*).*/);if(b&&11==b[2].length)return!0}return!1},validateWistiaUrl:function(a){return-1!==a.indexOf("wistia")},validateVimeoUrl:function(a){return-1!==a.indexOf("vimeo")},validateCustomUrl:function(a){var b=a.split(".").pop().toLowerCase();return"string"==typeof this.allowedMimeTypes[b]&&this.allowedMimeTypes[b]},reset:function(){this.set(_.extend({type:"video",display_type:1},this.defaults))},getOptions:function(){return _.extend({},this.defaults.options,this.getMediaOptionsBySource(this.getSource()),TGE_Editor.default_video_options[this.getSource()]||{},this.get("options"))},saveGlobals:function(){TGE_Editor["default_"+this.get("type")+"_options"][this.getSource()]=this.get("options"),TGE_Editor.default_video_style=this.get("style")},getUrlPlaceholder:function(){return"custom"===this.get("source")?TGE_Editor.t.media.placeholder_file_name:TGE_Editor.t.media.placeholder_url}}),TGE_Editor.models.Audio=TGE_Editor.models.Video.extend({defaults:_.extend({},TGE_Editor.models.Video.prototype.defaults,{source:"custom",url:"",options:{autoplay:{id:"autoplay",label:TGE_Editor.t.autoplay,value:0},loop:{id:"loop",label:TGE_Editor.t.loop,value:0},show_artwork:{id:"show_artwork",label:TGE_Editor.t.hide_artwork,value:0},show_user:{id:"show_user",label:TGE_Editor.t.hide_user,value:0}},players:{spotify:{},soundcloud:{auto_play:"auto_play",show_artwork:"show_artwork",show_user:"show_user"},custom:{autoplay:"autoplay",loop:"loop"}},audio_source:"custom",source_audio_labels:{spotify:TGE_Editor.t.audio_source_spotify,soundcloud:TGE_Editor.t.audio_source_soundcloud,custom:TGE_Editor.t.video_source_custom}}),allowedMimeTypes:{mp3:"audio/mpeg",mpeg:"audio/mpeg",m4a:"audio/mpeg",m4b:"audio/mpeg",ra:"audio/x-realaudio",ram:"audio/x-realaudio",wav:"audio/wav",ogg:"audio/ogg",oga:"audio/ogg",mid:"audio/midi",midi:"audio/midi",wma:"audio/x-ms-wma",wax:"audio/x-ms-wax",mka:"audio/x-matroska"},validateUrlBySource:function(a){var b=a||this.attributes.url,c=!1,d="validate"+TVE_Dash.upperFirst(this.attributes.audio_source)+"Url";return"function"==typeof this[d]&&(c=this[d](b)),c},hasOption:function(a){return!!this.getMediaOptionsBySource(this.get("audio_source"))[a]},getMediaOptionsBySource:function(a){var b={};switch(a){case"spotify":b={};break;case"soundcloud":b={auto_play:{id:"auto_play",label:TGE_Editor.t.autoplay,value:0},show_artwork:{id:"show_artwork",label:TGE_Editor.t.hide_artwork,value:0},show_user:{id:"show_user",label:TGE_Editor.t.hide_user,value:0}};break;case"custom":b={autoplay:{id:"autoplay",label:TGE_Editor.t.autoplay,value:0},loop:{id:"loop",label:TGE_Editor.t.loop,value:0}}}return b},validateSpotifyUrl:function(a){return 0===a.indexOf("https://open.spotify.com")},validateSoundcloudUrl:function(a){return 0===a.indexOf("https://soundcloud.com")},valid_bind_url:function(a){var b=!!this.validateUrlBySource(a);return this.trigger(b?"tge:video:valid:url":"tge:video:invalid:url",this),b},buildVideoParams:function(a){var b=void 0!==this.attributes.options?this.attributes.options:[],c=this.defaults.players,d=this.attributes.audio_source,e=[];return"spotify"===d&&(a=this.attributes.url.replace("https://open.spotify.com","")),_.each(c[d],function(a,c){var f=c,g=a,h=void 0!==b[f]?b[f].value:"0";switch(c){case"show_user":case"show_artwork":"soundcloud"===d&&(h=1===parseInt(h)?"false":"true");break;default:h=1===parseInt(h)?"true":"false"}e.push(g+"="+h)}),e.length>1?a+=e.join("&"):a},videoIdAndParams:function(){return this.buildVideoParams("")},reset:function(){this.set(_.extend({type:"audio",display_type:2},this.defaults))},getSource:function(){return this.get("audio_source")},getOptions:function(){return _.extend({},this.defaults.options,TGE_Editor.default_audio_options[this.getSource()]||{},this.get("options"))},sourceIsSpotify:function(){return"spotify"===this.getSource()},saveGlobals:function(){TGE_Editor["default_"+this.get("type")+"_options"][this.getSource()]=this.get("options"),TGE_Editor.default_video_style=this.get("style")},buildAutoplayParam:function(){var a=this.get("options");return void 0!==a.autoplay&&1===parseInt(a.autoplay.value)?"autoplay":""},buildLoopParam:function(){var a=this.get("options");return void 0!==a.loop&&1===parseInt(a.loop.value)?"loop":""},getUrlPlaceholder:function(){return"custom"===this.get("audio_source")?TGE_Editor.t.media.placeholder_file_name:TGE_Editor.t.media.placeholder_url}}),TGE_Editor.models.Text=TGE_Editor.models.Base.extend({getSource:function(){return""},getOptions:function(){return{}},getSource:function(){return"text"},saveGlobals:function(){TGE_Editor["default_"+this.get("type")+"_options"][this.getSource()]=this.get("options"),TGE_Editor.default_video_style=this.get("style")}}),TGE_Editor.models.AnswerButton=TGE_Editor.models.Answer.extend({defaults:_.extend({},TGE_Editor.models.Answer.prototype.defaults,{}),validate:function(){var a=TGE_Editor.models.Answer.prototype.validate.apply(this,arguments)||[];if(this.get("text").length<=0&&a.push(this.validation_error("text",TGE_Editor.t.answer_text_required)),a.length)return a}}),TGE_Editor.models.AnswerOpen=TGE_Editor.models.Answer.extend({defaults:_.extend({points:0},{}),validate:function(){}}),TGE_Editor.collections.Answers=Backbone.Collection.extend({model:function(a,b){var c="Answer",d=b.q_type?b.q_type:"";return c+=TVE_Dash.upperFirst(d),new TGE_Editor.models[c](a,b)},comparator:function(a,b){return a=a.get("order"),b=b.get("order"),a-b},resetToFirst:function(){var a=this.first();a.attributes.is_right=0,this.reset(a)}}),TGE_Editor.models.Connection=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{id:""}),url:function(){var a={route:"connection"};return TGE_Editor.models.Base.prototype.url.call(this,a)}}),TGE_Editor.models.Disconnecion=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{id:""}),url:function(){var a={route:"disconnection"};return TGE_Editor.models.Base.prototype.url.call(this,a)}}),TGE_Editor.models.Setting=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{quiz_id:TGE_Editor.quiz.ID,key:"",value:"",label:""}),modelId:function(){return this.get("key")},url:function(){var a={route:"settings"};return TGE_Editor.models.Base.prototype.url.call(this,a)},is_checked:function(){return void 0!==this.get("value")&&(!0===this.get("value")||this.get("value").length>0)}}),TGE_Editor.models.WeightsSetting=TGE_Editor.models.Setting.extend({defaults:_.extend({},TGE_Editor.models.Setting.prototype.defaults,{label:"Weights",key:"display_weight"})}),TGE_Editor.models.TagsSetting=TGE_Editor.models.Setting.extend({defaults:_.extend({},TGE_Editor.models.Setting.prototype.defaults,{label:"Tags",key:"display_tags"})}),TGE_Editor.models.FeedbackSetting=TGE_Editor.models.Setting.extend({defaults:_.extend({},TGE_Editor.models.Setting.prototype.defaults,{label:"Feedback",key:"display_feedback"})}),TGE_Editor.models.ProgressSetting=TGE_Editor.models.Setting.extend({defaults:_.extend({},TGE_Editor.models.Setting.prototype.defaults,{label:"",key:"display_progress"})}),TGE_Editor.models.ScrollSetting=TGE_Editor.models.Setting.extend({defaults:_.extend({},TGE_Editor.models.Setting.prototype.defaults,{label:"",key:"enable_scroll"})}),TGE_Editor.models.Scroll=TGE_Editor.models.Base.extend({defaults:function(){return{quiz_id:TGE_Editor.quiz.ID,enable_scroll:0}},url:function(){return TGE_Editor.models.Base.prototype.url.call(this,{route:"scroll"})}}),TGE_Editor.collections.Settings=Backbone.Collection.extend({url:function(b){return b=b||{route:"settings"},b=_.extend({},b,{action:TGE_Editor.ajax_controller_action,_nonce:TGE_Editor.nonce}),TGE_Editor.ajaxurl+"?"+a.param(b)},get_model:function(a){var b=this.findWhere({key:a});return b instanceof TGE_Editor.models.Setting?b:new TGE_Editor.models.Setting}}),TGE_Editor.models.QuestionSettings=TGE_Editor.models.Base.extend({defaults:{required:!1,form_size:1,placeholder:"Write your response here"},initialize:function(a){void 0===a&&this.set_defaults(),this.get("answer_limits")||this.set("answer_limits",this.get_answer_limits());var b=void 0===a||void 0===a.display_question_feedback?TGE_Editor.globals.settings.get_model("display_feedback").get("value"):a.display_question_feedback;this.set("display_feedback",TGE_Editor.quiz.display_feedback),this.set("display_question_feedback",b)},get_answer_limits:function(){return{min:{value:1,error_message:"Please write a minimum of (limit) characters"},max:{value:500,error_message:"You've exceeded the maximum number of (limit) characters"}}},set_defaults:function(){this.attributes.answer_limits=this.get_answer_limits()},set:function(a,b,c){if("string"==typeof a&&0===a.indexOf("settings.")){var d=a.split(".");return 4===d.length?this.attributes[d[1]][d[2]][d[3]]=b:2===d.length&&(this.attributes[d[1]]=b),this.trigger("change:"+a,this),this}return Backbone.Model.prototype.set.apply(this,arguments)}}),TGE_Editor.models.ProgressSettings=TGE_Editor.models.Base.extend({defaults:function(){return{percentage:60}},getTemplateId:function(){return TGE_Editor.quiz_style},url:function(){var a={route:"progress"};return TGE_Editor.models.Base.prototype.url.call(this,a)},getDefaultLabel:function(){return"percentage_completed"===this.get("percent_type")?"COMPLETED":"REMAINING"},getPercentToDisplay:function(){return"percentage_completed"===this.get("percent_type")?this.get("percentage"):100-this.get("percentage")}})}(jQuery);var TGE_Editor=TGE_Editor||{};TGE_Editor.modals=TGE_Editor.modals||{},function(a){a(function(){TGE_Editor.modals.ModalSteps=TVE_Dash.views.Modal.extend({stepClass:".tge-modal-step",currentStep:0,$step:null,events:{"click .tge-modal-next-step":"next","click .tge-modal-prev-step":"prev"},afterRender:function(){return this.steps=this.$el.find(this.stepClass).hide(),this.gotoStep(0),this},gotoStep:function(a){var b=this.steps.hide().eq(a).show(),c=this;return this.$step=b,setTimeout(function(){c.input_focus(b)},50),this.currentStep!==a&&(this.currentStep=a,this.trigger("modal:step_changed",parseInt(a))),this},next:function(){this.beforeNext(),this.gotoStep(this.currentStep+1),this.afterNext()},prev:function(){this.beforePrev(),this.gotoStep(this.currentStep-1),this.afterPrev()},beforeNext:function(){return this},afterNext:function(){return this},beforePrev:function(){return this},afterPrev:function(){return this},beforeClose:function(){this.$el.live_tooltip("remove"),a(".tvd-toast").remove(),a(".tvd-material-tooltip").remove()}}),TGE_Editor.modals.AddQuestion=TGE_Editor.modals.ModalSteps.extend({className:"tvd-modal-fixed-footer tvd-modal tge-modal tge-add-question-modal",template:TVE_Dash.tpl("modals/add-question"),events:_.extend({},TGE_Editor.modals.ModalSteps.prototype.events,{"click .tge-q-type":"onTypeSelected","click .tvd-modal-submit":"saveQuestion"}),initialize:function(a){TGE_Editor.modals.ModalSteps.prototype.initialize.apply(this,arguments),this.on("modal:step_changed",function(a){switch(this.$el.toggleClass("tqb-add-edit-q",1===parseInt(a)),a){case 1:this.renderQuestionForm(this._getFormWrapper()),this.$el.css({"max-width":"1100px",width:"80%",height:"90%","max-height":"90%"});break;default:this.$el.css({"max-width":this.data["max-width"],width:"",height:""}),this.form_view.remove()}},this)},afterRender:function(){return this.renderTypes(TGE_Editor.globals.question_types),TGE_Editor.modals.ModalSteps.prototype.afterRender.apply(this,arguments),this},input_focus:function(a){},renderTypes:function(a){var b=TVE_Dash.tpl("question/type-card");if(!(a instanceof Backbone.Collection))return!1;a.each(function(a,c,d){this._getListWrapper().append(b({item:a,selected:a.get("id")==this.model.get("q_type")}))},this)},_getListWrapper:function(){return this.$types_list_wrapper||(this.$types_list_wrapper=this.$("#tge-question-types")),this.$types_list_wrapper},_getFormWrapper:function(){return this.$form_wrapper||(this.$form_wrapper=this.$("#tge-question-form")),this.$form_wrapper},renderQuestionForm:function(a){this.$el.css({"max-width":"80%"});var b=_.extend({},this.model.defaults,{q_type:this.model.get("q_type"),position:this.model.get("position"),answers:new TGE_Editor.collections.Answers,settings:this.model.get("settings"),id:""});this.model.clear({silent:!0}),this.model.set(b),this.form_view=new TGE_Editor.views.GeneralQuestion({model:this.model}),this.form_view.render(),a.html(this.form_view.$el),TVE_Dash.materialize(a)},onTypeSelected:function(b){this.model.set("q_type",b.currentTarget.dataset.id),TVE_Dash.select_card(a(b.currentTarget),this._getListWrapper().find(".tge-q-type"))},next:function(){this.beforeNext()&&(this.gotoStep(this.currentStep+1),this.afterNext())},beforeNext:function(){return!!this.model.get("q_type")||(TVE_Dash.err(TGE_Editor.t.select_question_type),!1)},validateSettings:function(){var a=this.model.get("settings").get("answer_limits").min.value,b=this.model.get("settings").get("answer_limits").max.value,c=!0;return(isNaN(a)||parseInt(a)<0)&&(TVE_Dash.err("Invalid minimum characters limit"),c=!1),(isNaN(b)||parseInt(b)<0)&&(TVE_Dash.err("Invalid maximum characters limit"),c=!1),parseInt(a.length)<=0&&(TVE_Dash.err("Error message for minimum characters limit cannot be empty"),c=!1),parseInt(b.length)<=0&&(TVE_Dash.err("Error message for maximum characters limit cannot be empty"),c=!1),parseInt(a)>parseInt(b)&&(TVE_Dash.err("Minimum limit cannot be higher than the maximum limit"),c=!1),this.model.get("settings").get("placeholder").length||(TVE_Dash.err("Placeholder text cannot be empty"),c=!1),c},saveDisplayGlobals:function(){var a=this.model.get("display_settings");void 0!==a&&a.saveGlobals()},saveQuestion:function(){if(this.model.isValid()&&(this.saveDisplayGlobals(),this.validateSettings())){var a=this;0===window.tge_app_view.questions.length&&(this.model.set("start","1"),this.model.set("position",{x:tge_app_view.startFlow.position().x+tge_app_view.startFlow.get("size").width/2,y:tge_app_view.startFlow.position().y+100})),window.tge_app_view.saving(),TVE_Dash.showLoader(),this.model.save(null,{success:function(b,c,d){window.tge_app_view.questions.add(a.model),window.opener&&window.opener.postMessage({event:"tqb_question_counter_update",number:window.tge_app_view.questions.length},"*")},error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){TVE_Dash.hideLoader(),window.tge_app_view.change_automatically_saved(),a.close()}})}}}),TGE_Editor.modals.DeleteQuestion=TVE_Dash.views.Modal.extend({template:TVE_Dash.tpl("modals/delete-question"),events:{"click .tve-confirm-delete-action":"delete"},afterRender:function(){this.$el.addClass("tvd-red")},delete:function(){var a=window.tge_app_view.questions.findWhere({id:this.model.id});if(a instanceof TGE_Editor.models.Question){var b=this;TVE_Dash.showLoader(),a.destroy({success:function(a,c){TVE_Dash.success(TGE_Editor.t.question_success_deleted),b.model.remove(),window.opener&&window.opener.postMessage({event:"tqb_question_counter_update",number:window.tge_app_view.questions.length},"*")},error:function(a,b){TVE_Dash.err(TGE_Editor.t.question_error_deleted)},complete:function(){TVE_Dash.hideLoader(),b.close()}})}}}),TGE_Editor.modals.EditQuestion=TGE_Editor.modals.AddQuestion.extend({renderQuestionForm:function(a){this.$el.css({"max-width":"80%"}),this.model.isOpenEndedType()&&this.model.get("answers").length>1&&this.model.get("answers").resetToFirst(),this.form_view=new TGE_Editor.views.GeneralQuestionEdit({model:this.model}),this.form_view.render(),a.html(this.form_view.$el),TVE_Dash.materialize(a)},afterRender:function(){TGE_Editor.modals.AddQuestion.prototype.afterRender.apply(this,arguments),this.next(),this.$(".tge-modal-prev-step").html(TGE_Editor.t.change_question_type),this.$(".tvd-modal-title").html(TGE_Editor.t.edit_question)},htmlDecode:function(a){var b=document.createElement("textarea");return b.innerHTML=a,b.value},saveQuestion:function(){if(this.model.isValid()&&(this.saveDisplayGlobals(),this.validateSettings())){var a=this;TVE_Dash.showLoader(),window.tge_app_view.saving(),this.model.set("text",this.htmlDecode(this.model.get("text"))),this.model.save(null,{success:function(a,b,c){window.tge_app_view.graph.getCell(a.get("id")).set(a.toDeepJSON())},error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){TVE_Dash.hideLoader(),window.tge_app_view.change_automatically_saved(),a.close()}})}}}),TGE_Editor.modals.QuizzSettings=TVE_Dash.views.Modal.extend({template:TVE_Dash.tpl("modals/quiz-settings"),className:"tvd-modal tqb-progressbar-modal",events:{"click .tvd-modal-submit":"save","click .tvd-modal-close":"_close","click .tqb-reset-progress-bar":"resetProgressBar"},afterInitialize:function(){this.listenTo(this.model,"change",this.renderProgressBar)},afterRender:function(){this.$el.css({"max-width":"830px"}),new TGE_Editor.views.Switcher({model:new TGE_Editor.models.ProgressSetting({value:1===parseInt(this.model.get("display_progress")),key:"display_progress",label:"Progress bar"}),el:this.$("#tge-progress-switcher")}).render().model.on("change:value",function(a){this.model.set("display_progress",!0===a.get("value")?1:0),this.$(".tqb-progress-options").toggleClass("tvd-hide",!1===a.get("value"))},this),this.$(".tqb-progress-options").toggleClass("tvd-hide",1!==parseInt(this.model.get("display_progress"))),this.renderContent()},renderContent:function(){this.renderOptions(),this.renderColorPicker(),this.renderProgressBar(),TVE_Dash.data_binder(this),TVE_Dash.materialize(this.$el)},resetProgressBar:function(a){a.preventDefault(),this.model.attributes.percent_type=TGE_Editor.progress_bar_defaults.percent_type,this.model.set(_.extend({},TGE_Editor.progress_bar_defaults,{label_text:this.model.getDefaultLabel()})),this.renderContent()},renderColorPicker:function(){var a=this
;this.$color_picker=this.$("#tqb-color-fill-overlay").spectrum({containerClassName:"tqb-color-picker",allowEmpty:!0,showInitial:!0,showButtons:!0,cancelText:TGE_Editor.t.media.cancel,preferredFormat:"hex",showInput:!0,change:function(b){a.model.set("fill_color",b.toHexString()),a.$("#tqb-fill-overlay-code").val(b.toHexString())},move:function(a){}}),this.$next_step_picker=this.$("#tqb-color-next-step-overlay").spectrum({containerClassName:"tqb-color-picker",allowEmpty:!0,showInitial:!0,showButtons:!0,cancelText:TGE_Editor.t.media.cancel,preferredFormat:"hex",showInput:!0,change:function(b){a.model.set("next_step_color",b.toHexString()),a.$("#tqb-color-overlay-code").val(b.toHexString())},move:function(a){}}),this.$background_picker=this.$("#tqb-color-background-overlay").spectrum({containerClassName:"tqb-color-picker",allowEmpty:!0,showInitial:!0,showButtons:!0,cancelText:TGE_Editor.t.media.cancel,preferredFormat:"hex",showInput:!0,change:function(b){a.model.set("background_color",b.toHexString()),a.$("#tqb-background-color-code").val(b.toHexString())},move:function(a){}}),this.$label_picker=this.$("#tqb-color-label-overlay").spectrum({containerClassName:"tqb-color-picker",allowEmpty:!0,showInitial:!0,showButtons:!0,cancelText:TGE_Editor.t.media.cancel,preferredFormat:"hex",showInput:!0,change:function(b){a.model.set("label_color",b.toHexString()),a.$("#tqb-color-label-code").val(b.toHexString())},move:function(a){}})},renderOptions:function(){new TGE_Editor.views.ProgressBarOptions({model:this.model,el:this.$(".tqb-progress-bar-options")}).render()},renderProgressBar:function(){new TGE_Editor.views.ProgressBar({model:this.model,el:this.$(".tqb-progress-bar")}).render()},validate:function(){return this.model.get("font_size")<10?(TVE_Dash.err(TGE_Editor.t.low_font_size_value),!1):!(this.model.get("font_size")>50)||(TVE_Dash.err(TGE_Editor.t.high_font_size_value),!1)},hideColorPickers:function(){this.$color_picker.spectrum("destroy"),this.$next_step_picker.spectrum("destroy"),this.$background_picker.spectrum("destroy"),this.$label_picker.spectrum("destroy")},save:function(){if(!0===this.validate()){TVE_Dash.showLoader(),this.hideColorPickers();var a=this;this.model.save(null,{success:function(a,b,c){TGE_Editor.globals.preogress_settings.set(JSON.parse(JSON.stringify(a)))},error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){TVE_Dash.hideLoader(),a.close()}})}},_close:function(){this.hideColorPickers(),this.close()}})})}(jQuery);var TGE_Editor=TGE_Editor||{};TGE_Editor.views=TGE_Editor.views||{},TGE_Editor.globals=TGE_Editor.globals||{},TGE_Editor.const=TGE_Editor.const||{},_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},TGE_Editor.const={answers_per_row:5,answer:{margin:{left:20,bottom:10},image:{size:{width:100,height:100}},size:{width:150,height:30}},question:{image:{size:{width:100}},size:{height:30}},navigator:{size:{width:250,height:250}},paper:{size:{width:5e3,height:5e3}}},TGE_Editor.globals.question_types=new Backbone.Collection(TGE_Editor.question_types);var weights_setting=new TGE_Editor.models.WeightsSetting({value:TGE_Editor.quiz.display_weight,key:"display_weight",label:"Weights"}),tags_setting=new TGE_Editor.models.TagsSetting({value:TGE_Editor.quiz.display_tags,key:"display_tags",label:"Tags"});TGE_Editor.globals.display_feedback=function(){return void 0!==TGE_Editor.quiz.highlight_settings&&"undefined"!==TGE_Editor.quiz.feedback_settings&&("survey"!==TGE_Editor.quiz.quiz_type&&("right_wrong"===TGE_Editor.quiz.quiz_type?1===TGE_Editor.quiz.highlight_settings.highlight_and_show_feedback:1===TGE_Editor.quiz.feedback_settings.display_feedback||1===TGE_Editor.quiz.feedback_settings.press_next))};var feedback_setting=new TGE_Editor.models.FeedbackSetting({value:TGE_Editor.globals.display_feedback(),key:"display_feedback",label:"Feedback"});TGE_Editor.globals.settings=new TGE_Editor.collections.Settings,TGE_Editor.globals.settings.add(weights_setting),TGE_Editor.globals.settings.add(tags_setting),TGE_Editor.globals.settings.add(feedback_setting);var args={quiz_id:TGE_Editor.quiz.ID};_.each(TGE_Editor.quiz.progress_settings,function(a,b){args[b]=a}),TGE_Editor.globals.preogress_settings=new TGE_Editor.models.ProgressSettings(args),TGE_Editor.globals.settings.on("change",function(){this.save()}),function(a){a(function(){TGE_Editor.views.AppView=Backbone.View.extend({el:"#tge-app",selectedCell:null,notMovableModels:["tge.Answer","tge.AnswerImage","tge.NewQuestion","tge.StartFlow"],sidebarList:null,costs:[],$saving_status:null,attrLinks:{".connection":{stroke:"#87548d","stroke-width":2}},events:{scroll:"on_scroll"},initialize:function(){this.$scrollers=a(".tge-scroll"),this.$collapseBtn=a("#tge-slide-cp"),this.$collapseBtn.click(_.bind(this.toggle_control_panel,this)),this.$saving_status=a("#tge-saving-status"),this.sidebarList=a("#tge-items-list"),this.questions=new TGE_Editor.collections.Questions(TGE_Editor.questions),this.answers=new Backbone.Collection,this.$add_new_question=a("#tge-add-new-question").click(this.add_new_question),a(".tqb-quiz-settings").click(this.showProgressSettings),this.listenTo(this.questions,"add",function(a){this.loadNewQuestion(a)},this),this.listenTo(this.questions,"remove",function(){this.render_sidebar_list()},this),this.listenTo(this.questions,"change:text",function(){this.updateAnswersCollection(),this.render_sidebar_list()}),this.render_sidebar_list(),this.renderProgressSettings(),this.initializePaper(),this.initializeNavigatorPaper(),this.loadQuestions(),this.initializeStart(),this.updateAnswersCollection(),this.int_navigator(),this.$scrollers.hide(),this.$(".tge-loader").remove()},initializeNewQuestionButton:function(){_.isUndefined(this.newQuestionButton)&&(this.newQuestionButton=new joint.shapes.tge.NewQuestion({id:"new-question"}),this.graph.addCell(this.newQuestionButton));var a={x:TGE_Editor.const.paper.size.width/2-this.$el.width()/2+50,y:50};this.newQuestionButton.position(a.x,a.y)},initializeStart:function(){_.isUndefined(this.startFlow)&&(this.startFlow=new joint.shapes.tge.StartFlow({id:"start"}),this.graph.addCell(this.startFlow));var a=TGE_Editor.const.paper.size.width,b={x:a/2-this.startFlow.get("size").width/2,y:50};this.startFlow.position(b.x,b.y);var c=this.graph.get("cells").findWhere({start:"1"});c&&this.createStartLink(c)},createStartLink:function(a){this.create_link({id:"start",port:"start-port",selector:"g:nth-child(1) > g:nth-child(5) > circle:nth-child(1)"},{id:a.id,port:"q-in-port-"+a.id,selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)"})},initializeNavigatorPaper:function(){function b(a){var b=d.$el.scrollTop(),c=d.$el.scrollLeft();switch(a){case"bottom":if(b>=TGE_Editor.const.paper.size.height-h.height)return;b+=e,d.$el.scrollTop(b),d.$nav_handler.css({top:b/g});break;case"top":if(b<=-e)return;b-=e,d.$el.scrollTop(b),d.$nav_handler.css({top:b/g});break;case"right":if(c>=TGE_Editor.const.paper.size.width-h.width)return;c+=e,d.$el.scrollLeft(c),d.$nav_handler.css({left:c/f});break;case"left":if(c<=-e)return;c-=e,d.$el.scrollLeft(c),d.$nav_handler.css({left:c/f})}}var c=new joint.dia.FastPaper({preventContextMenu:!1,el:a("#tge-nav-paper"),width:TGE_Editor.const.navigator.size.width,height:TGE_Editor.const.navigator.size.height,model:this.graph});this.scale=TGE_Editor.const.navigator.size.width/this.paper.options.width,c.scale(this.scale);var d=this,e=10,f=(this.$el.scrollTop(),this.$el.scrollLeft(),TGE_Editor.const.paper.size.width/TGE_Editor.const.navigator.size.width),g=TGE_Editor.const.paper.size.height/TGE_Editor.const.navigator.size.height,h={width:this.$el.width(),height:this.$el.height()};setTimeout(function(){d.$el.animate({scrollLeft:TGE_Editor.const.paper.size.width/2-h.width/2},500,"swing")},500);var i;this.$scrollers.on("mouseover",function(a){var c=a.target.dataset.dir;i=setInterval(function(){b(c)},10)}).on("mouseout",function(){clearInterval(i)})},initializePaper:function(){var a=this;this.graph=new joint.dia.Graph,this.paper=new joint.dia.FastPaper({preventContextMenu:!1,restrictTranslate:!0,el:this.$("#tge-paper"),width:TGE_Editor.const.paper.size.width,height:TGE_Editor.const.paper.size.height,model:this.graph,gridSize:1,snapLinks:{radius:50},linkPinning:!1,markAvailable:!0,clickThreshold:1,defaultLink:new tgeLink({router:{name:"manhattan"},connector:{name:"rounded"},attrs:this.attrLinks}),interactive:function(a){return!(a.model instanceof joint.dia.Link)||{vertexAdd:!1}},validateConnection:function(b,c,d,e,f,g){var h=b.model.get("question_id");if(h){if(e.getAttribute("qid")===h+"q")return!1}var i=c.getAttribute("port"),j=a.graph.getConnectedLinks(b.model,{outbound:!0});return!(_.filter(j,function(a){return a.get("source").port==i}).length>1||c&&"in"===c.getAttribute("port-group")||e&&"out"===e.getAttribute("port-group")||c&&e&&c.getAttribute("qid")===e.getAttribute("qid")||b===d)}}),this.paper.on("cell:pointerdown",this.onCellPointerdown,this),this.paper.on("cell:pointerup",this.onCellPointerup,this),this.paper.on("link:connect",this.onLinkConnect,this),this.paper.on("cell:mouseover",this.onCellMouseover,this),this.paper.on("cell:mouseout",this.onCellMouseout,this),this.graph.on("remove",this.onGraphRemove,this),this.graph.on("add",this.onGraphAdd,this),this.graph.on("change:position",this.onGraphChangePosition,this)},loadQuestions:function(){this.graph.fromJSON({cells:TGE_Editor.questions},{silent:!1});var a=this.graph.get("cells").where({type:"tge.Answer"}),b=this.graph.get("cells").where({type:"tge.AnswerImage"});_.each(_.union(a,b),function(a,b,c){if(a.get("next_question_id")){var d,e;d={id:a.get("id"),selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)",port:"a-port-"+a.get("id")},e={id:a.get("next_question_id")+"q",selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)",port:"q-in-port-"+a.get("next_question_id")+"q"},this.create_link(d,e)}},this);var c=this.graph.get("cells").where({type:"tge.Question"});_.each(c,function(a,b,c){if(a.get("next_question_id")){var d,e;d={id:a.get("id"),selector:"g:nth-child(1) > g:nth-child(4) > circle:nth-child(1)",port:"q-out-port-"+a.get("id")},e={id:a.get("next_question_id"),selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)",port:"q-in-port-"+a.get("next_question_id")},this.create_link(d,e)}},this)},loadNewQuestion:function(a){var b,c=a.toDeepJSON(),d=this.graph.getCell(c.id),e=-1,f=0;if(d?(d.set(c),b=d):(b=new joint.shapes.tge.Question(_.extend(c,{})),this.graph.addCell(b)),_.each(c.answers,function(a,d,g){d&&d%TGE_Editor.const.answers_per_row==0&&(e=-1,f++),e++,this.loadNewAnswer(a,b,c,e,f)},this),1==b.get("start")){this.createStartLink(b);var g=b.position(),h={x:g.x-b.get("size").width/2,y:g.y};this.selectedCell=this.paper.findViewByModel(b),b.position(h.x,h.y),b.loadAnswers(),this.paper.trigger("cell:pointerup",this.selectedCell),this.render_sidebar_list()}},loadNewAnswer:function(a,b,c,d,e){var f,g=this.graph.getCell(a.id);g?g.set(a):(f=new joint.shapes.tge.Answer(_.extend(a,{col:d,row:e,jQuestion:b.toJSON()})),b.embed(f),this.graph.addCell(f))},create_link:function(a,b){var c={type:"link",source:{id:"qqqq1",selector:"g:nth-child(1) > g:nth-child(4) > circle:nth-child(1)",port:"q-out-port-q1"},target:{id:"q2",selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)",port:"q-in-port-q2"},router:{name:"manhattan"},connector:{name:"rounded"},embeds:"",z:16,attrs:this.attrLinks};if(a&&(c.source=a),b&&(c.target=b),this.graph.getCell(c.source.id)&&this.graph.getCell(c.target.id)){var d=new tgeLink(c);this.graph.addCell(d)}},disconnect_link:function(a,b){if(a.id&&b.id){var c=new TGE_Editor.models.Disconnecion({source:a,target:b});window.tge_app_view.saving(),c.save(null,{error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){window.tge_app_view.change_automatically_saved()}})}},save_link:function(a,b,c){var d=new TGE_Editor.models.Connection({source:a,target:b});window.tge_app_view.saving(),d.save(null,{error:function(a,b){c.model.disconnect(),TVE_Dash.err(b.responseJSON.data.message)},complete:function(){window.tge_app_view.change_automatically_saved()}})},renderQuestion:function(a){var b=new TGE_Editor.views.QuestionView({model:a});this.sidebarList.append(b.render().$el)},onCellPointerup:function(a,b){this.selectedCell=null;var c=b?b.target.getAttribute("class"):null;if("tge-remove-tool"!==c&&"tge-edit-tool"!==c&&"tge.Question"===a.model.get("type")&&a.model.changed.position){var d=this.questions.findWhere({id:a.model.id});d.set("position",a.model.get("position")),window.tge_app_view.saving(),d.save(null,{complete:function(){window.tge_app_view.change_automatically_saved()}})}this.$scrollers.hide()},onCellPointerdown:function(a){this.selectedCell=a,this.$scrollers.show()},onCellMouseover:function(a){"tge.Question"===a.model.get("type")&&a.$(".tge-question-tools").attr("style","display: inline")},onCellMouseout:function(a){"tge.Question"===a.model.get("type")&&a.$(".tge-question-tools").attr("style","display: none")},onLinkConnect:function(a){if(this.save_link(a.model.get("source"),a.model.get("target"),a),"start"===a.model.get("source").id){var b=this.questions.findWhere({id:a.model.get("target").id});b instanceof Backbone.Model&&b.set("start","1")}else{var c,d=a.model.get("source").id;c=-1!==d.indexOf("a")?this.answers.findWhere({id:d}):this.questions.findWhere({id:d}),c instanceof Backbone.Model&&c.set("next_question_id",a.model.get("target").id)}this.render_sidebar_list()},onGraphRemove:function(a){if(a.isLink()&&!_.isUndefined(a.get("source").id)&&!_.isUndefined(a.get("target").id)){if(this.disconnect_link(a.get("source"),a.get("target")),"start"===a.get("source").id){var b=this.questions.findWhere({id:a.get("target").id});b instanceof Backbone.Model&&b.set("start",null)}else{var c,d=a.get("source").id;c=-1!==d.indexOf("a")?this.answers.findWhere({id:d}):this.questions.findWhere({id:d}),c instanceof Backbone.Model&&c.set("next_question_id",null)}this.render_sidebar_list()}},onGraphAdd:function(a){"tge.Question"===a.get("type")&&a.loadAnswers()},onGraphChangePosition:function(a){this.selectedCell&&-1!==_.indexOf(this.notMovableModels,this.selectedCell.model.get("type"))&&a.set("position",a.previous("position"))},render_questions:function(a,b){if(void 0===b&&(b=0),a instanceof Backbone.Model&&a.get("answers")instanceof Backbone.Collection){a.attributes.level=b,!0!==a.get("rendered")&&this.renderQuestion(a);var c=a.get("next_question_id"),d=null;c&&(d=this.questions.findWhere({id:c.replace("q","")+"q"})),a.get("answers").each(function(a,c,d){if(a.get("next_question_id")){var e=a.get("next_question_id"),f=this.questions.findWhere({id:e.replace("q","")+"q"}),g=b;f instanceof Backbone.Model&&(g++,this.render_questions(f,g))}},this),d instanceof Backbone.Model&&this.render_questions(d,b)}},_get_paths:function(a,b,c,d){if(!_.isUndefined(a)){var e={q:a.get("text"),points:b,path_key:c,paths:[],level:d};return!0!==a.get("rendered")&&(a.attributes.level=d,a.attributes.path=c,this.renderQuestion(a)),a.get("answers").each(function(f,g,h){var i=d;f.get("next_question_id")&&i++;var j=f.get("next_question_id")?f.get("next_question_id"):a.get("next_question_id");j=j||"";var k=this.questions.findWhere({id:j.replace("q","")+"q"}),l=parseInt(f.get("points"));k instanceof Backbone.Model?e.paths.push(this._get_paths(k,b+l,c+":"+f.get("text"),i)):(e.paths.push({path_key:c+":"+f.get("text"),points:f.get("points")}),this.costs.push(b+l))},this),e}},render_sidebar_list:function(){this.sidebarList.empty(),this.questions.each(function(a){a.attributes.rendered=!1});try{this.render_questions(this.questions.findWhere({start:"1"}),0,"Start",0)}catch(a){TVE_Dash.err("Please check the links and break the loops.")}},updateAnswersCollection:function(){this.answers.reset(),this.questions.each(function(a){a.get("answers").each(function(a){this.answers.push(a)},this)},this)},saving:function(){this.$saving_status.html(TGE_Editor.t.saving)},change_automatically_saved:function(){this.$saving_status.html('<span class="tvd-icon-question-circle"></span><span>'+TGE_Editor.t.changes_automatically_saved+"</span>")},toggle_control_panel:function(b){var c=this;a("#tge-control-panel").toggleClass("tge-cp-collapsed"),this.$el.toggleClass("tge-cp-collapsed"),setTimeout(function(){b.cp_collapsed=c.$el.hasClass("tge-cp-collapsed"),c.trigger("tge:cp:collapse",b)},700)},int_navigator:function(){a("#tge-nav-control").click(function(){var b=a(this);if(b.hasClass("tvd-icon-minus"))return a("#tge-nav-paper").css({height:0}),b.removeClass("tvd-icon-minus").addClass("tvd-icon-plus"),void b.attr("data-tooltip",TGE_Editor.t.maximize);a("#tge-nav-paper").css({height:250}),b.removeClass("tvd-icon-plus").addClass("tvd-icon-minus"),b.attr("data-tooltip",TGE_Editor.t.minimize)});var b={get_size:function(a){var b={width:10,height:10},c=TGE_Editor.const.paper.size.width,d=TGE_Editor.const.paper.size.height,e={width:a.width/c,height:a.height/d};return b.width=TGE_Editor.const.navigator.size.width*e.width,b.height=TGE_Editor.const.navigator.size.height*e.height,{width:b.width+"px",height:b.height+"px"}}},c=this,d={width:this.$el.width(),height:this.$el.height()};this.$nav_handler=a("#tge-nav-handler");var e=TGE_Editor.const.paper.size.width/TGE_Editor.const.navigator.size.width,f=TGE_Editor.const.paper.size.height/TGE_Editor.const.navigator.size.height;this.$nav_handler.css(b.get_size(d)),this.$nav_handler.draggable({containment:"parent",drag:function(a,b){var c=b.position.left*e,d=b.position.top*f;tge_app_view.$el.scrollLeft(c),tge_app_view.$el.scrollTop(d)}}),this.on("tge:cp:collapse",function(a){var d={width:this.$el.width(),height:this.$el.height()},e=b.get_size(d);c.$nav_handler.css(e)})},on_scroll:function(a){var b=a.target.scrollTop,c=a.target.scrollLeft,d=TGE_Editor.const.paper.size.width/TGE_Editor.const.navigator.size.width,e=TGE_Editor.const.paper.size.height/TGE_Editor.const.navigator.size.height;this.$nav_handler.css({top:b/e,left:c/d})},add_new_question:function(){var a={x:150+tge_app_view.$el.scrollLeft(),y:150+tge_app_view.$el.scrollTop()},b=new TGE_Editor.models.Question({position:a});TVE_Dash.modal(TGE_Editor.modals.AddQuestion,{model:b,dismissible:!1,"max-width":"40%"})},renderProgressSettings:function(){new TGE_Editor.views.ProgressSettings({el:a(".tqb-progress-settings"),model:TGE_Editor.globals.preogress_settings}).render()},showProgressSettings:function(){a(".tqb-progress-settings").addClass("tqb-show-progress"),a(".tqb-quiz-settings").addClass("tqb-qs-gray")}}),TGE_Editor.views.ProgressSettings=Backbone.View.extend({template:TVE_Dash.tpl("progress/settings"),events:{"click .tqb-hide-progress-settings":function(){this.$el.removeClass("tqb-show-progress"),a(".tqb-quiz-settings").removeClass("tqb-qs-gray")},"click .tqb-progress-holder":function(){TVE_Dash.modal(TGE_Editor.modals.QuizzSettings,{"max-width":"80%",model:new TGE_Editor.models.ProgressSettings(JSON.parse(JSON.stringify(TGE_Editor.globals.preogress_settings))),complete:function(){}})}},initialize:function(){this.listenTo(this.model,"change:display_progress",this.render)},render:function(){return this.$el.html(this.template({model:this.model})),this.renderScrollSettings(),this},renderScrollSettings:function(){new TGE_Editor.views.ScrollSettings({el:a(".tqb-scroll-settings"),model:new TGE_Editor.models.Scroll(TGE_Editor.quiz.scroll_settings)}).render()}}),TGE_Editor.views.ScrollSettings=Backbone.View.extend({template:TVE_Dash.tpl("scroll/settings"),render:function(){return this.$el.html(this.template({model:this.model})),new TGE_Editor.views.Switcher({model:new TGE_Editor.models.ScrollSetting({value:1===parseInt(this.model.get("enable_scroll"))}),el:this.$("#tge-scroll-switcher")}).render().model.on("change:value",function(a){this.model.attributes.enable_scroll=!0===a.get("value")?1:0,this.model.save(null,{complete:function(){TVE_Dash.success(TGE_Editor.t.scroll_settings_saved)}})},this),this}}),TGE_Editor.views.TypeSwitcher=Backbone.View.extend({events:{"click #tge-question-type-selector":function(){this.closeDropdowns(),this.toggleOptions()}},template:TVE_Dash.tpl("question/type_switcher"),render:function(){return this.$el.html(this.template({model:this.model})),this},toggleOptions:function(){this.$(".tge-question-display-type").toggleClass("tvd-hiddendiv")},closeDropdowns:function(){a(".tge-video-source-dropdown, .tge-video-style-dropdown, .tge-display-options-data").addClass("tvd-hiddendiv")}}),TGE_Editor.views.FormQuestion=Backbone.View.extend({template:TVE_Dash.tpl("question/form"),settingsTemplate:TVE_Dash.tpl("question/settings"),answers_views:[],events:{"click #tge-qf-add-description":"add_description_field","click #tge-gf-delete-description":"remove_description_field","click #tge-qf-add-answer":function(){this.model.isOpenEndedType()||this.add_answer()},"keyup #tge-question-description-textarea":function(a){a.stopPropagation()},"keyup .tge-answer-text":function(a){a.stopPropagation(),13===a.keyCode&&this.add_answer()},"keyup #tge-question-feedback":function(a){this.model.set({feedback:a.target.value},{silent:!0})}},initialize:function(){this.listenTo(this.model.get("answers"),"add",this.renderAnswerForm),this.listenTo(this.model.get("answers"),"remove",function(a){1===parseInt(a.get("is_right"))&&this.model.get("answers").first().set("is_right",1)});var a=this;this.model.on("tge:video:renderEmbed",function(b){a.renderEmbededVideo()}),this.model.on("tge:video:disableAutoplay",function(b){a.disableAutoplay()}),this.model.on("tge:video:enableAutoplay",function(b){a.enableAutoplay()})},toggle_feedback:function(){!0===this.model.display_feedback()?this.$(".tge-feedback-column").show():this.$(".tge-feedback-column").hide()},render:function(){return this.$el.html(this.template({item:this.model})),this.model.isOpenEndedType()&&(this.$("#tge-qf-add-answer").hide(),this.renderSettings()),TVE_Dash.data_binder(this),this.renderAnswers(this.model.get("answers")),this.renderImagePicker(this.$("#tge-qf-image-loader")),"personality"===TGE_Editor.quiz.quiz_type&&!1===this.model.isOpenEndedType()&&this.render_weight_switcher(),!1===this.model.isOpenEndedType()&&(this.render_tags_switcher(),this.render_feedback_switcher()),0===this.model.get("answers").length&&this.add_answer(),setTimeout(function(a){a.$("input#tge-question-text").first().focus()},10,this),this},checkDisabledThumb:function(){var a=this.model.get("display_settings")instanceof Backbone.Model?this.model.get("display_settings"):this.model,b=a.get("options");void 0!==a&&void 0!==b.autoplay&&1===parseInt(b.autoplay.value)&&(this.model.trigger("tge:video:disableVideoThumb"),this.model.trigger("tge:video:removeVideoThumb"))},disableAutoplay:function(){this.$(".tge-v_option-autoplay").attr("disabled","disabled")},enableAutoplay:function(){this.$(".tge-v_option-autoplay").removeAttr("disabled")},render_weight_switcher:function(){new TGE_Editor.views.Switcher({model:TGE_Editor.globals.settings.get_model("display_weight"),el:this.$("#tge-points-switcher")}).render()},render_tags_switcher:function(){new TGE_Editor.views.TagsSwitcher({model:TGE_Editor.globals.settings.get_model("display_tags"),el:this.$("#tge-tags-switcher")}).render()},render_feedback_switcher:function(){if(TGE_Editor.globals.display_feedback()){var a=new TGE_Editor.views.Switcher({model:new TGE_Editor.models.FeedbackSetting({value:this.model.get("id")?this.model.get("settings").get("display_question_feedback"):TGE_Editor.globals.settings.get_model("display_feedback").get("value"),key:"display_feedback",label:"Feedback"}),el:this.$("#tge-feedback-switcher")});a.render(),this.toggle_feedback(),this.listenTo(a.model,"change:value",function(){this.model.get("settings").set({display_question_feedback:a.model.get("value")},{silent:!0}),TGE_Editor.globals.settings.get_model("display_feedback").set({value:a.model.get("value")}),this.toggle_feedback()})}},renderAnswerForm:function(a){a.off("change:is_right");var b=this,c=TGE_Editor.globals.question_types.findWhere({id:parseInt(this.model.get("q_type"))});if(c instanceof Backbone.Model&&"function"==typeof TGE_Editor.views["FormAnswer"+TVE_Dash.upperFirst(c.get("key"))]){var d=new(TGE_Editor.views["FormAnswer"+TVE_Dash.upperFirst(c.get("key"))])({model:a,collection:this.model.get("answers"),question:this.model});this.answers_views.push(d),this._getAnswersWrapper().append(d.render().$el).sortable({handle:this.$(".tge-sort-handle"),placeholder:"tge-sortable-placeholder",sort:function(a,b){b.placeholder.css({border:"2px dashed gray",width:b.helper.css("width"),height:b.helper.css("height"),margin:b.helper.css("margin")})},update:function(){b.update_answers_order()}}),TVE_Dash.materialize(d.$el)}},update_answers_order:function(){_.each(this.answers_views,function(a,b,c){a.model.attributes.order=a.$el.index()},this)},_getAnswersWrapper:function(){return this.$answers_wrapper||(this.$answers_wrapper=this.$("#tge-answers-wrapper")),this.$answers_wrapper},add_description_field:function(){this.$("#tge-question-description").show(),this.$("#tge-qf-add-description").hide(),this.$("#tge-question-description-textarea").trigger("autoresize").focus().select()},add_answer:function(){if(this.model.get("answers").findWhere(this.model.isImageType()?{image:""}:{text:""})instanceof Backbone.Model)return void TVE_Dash.err(this.model.isImageType()?TGE_Editor.t.invalid_image_answer:TGE_Editor.t.invalid_text_answer);var a=TGE_Editor.globals.question_types.findWhere({id:parseInt(this.model.get("q_type"))}),b="Answer";a instanceof Backbone.Model&&"function"==typeof TGE_Editor.models[b+TVE_Dash.upperFirst(a.get("key"))]&&(b+=TVE_Dash.upperFirst(a.get("key")));var c=new TGE_Editor.models[b]({order:this.model.get("answers").length});"right_wrong"===TGE_Editor.quiz.quiz_type&&(c.set("points",0),0===this.model.get("answers").length&&(c.set("is_right",1),c.set("points",1))),"personality"===TGE_Editor.quiz.quiz_type&&c.set("result_id",0),this.model.get("answers").push(c),this.$el.find(".tge-answer-text").last().focus()},remove_description_field:function(){this.model.set("description",""),this.$("#tge-qf-add-description").html(TGE_Editor.t.add_description),this.$("#tge-question-description").hide(),this.$("#tge-qf-add-description").show()},renderAnswers:function(a){this.answers_views=[],a instanceof Backbone.Collection&&a.each(function(a,b,c){this.renderAnswerForm(a)},this)},renderImagePicker:function(a){new TGE_Editor.views.ImagePicker({model:this.model,el:a}).render()},renderEmbededVideo:function(b){b=b||this.$el.find("#tge-qf-video-loader");var c=this.model instanceof TGE_Editor.models.Video?this.model:this.model.get("display_settings"),d=c.getSource();if(c.set("url",a.trim(c.get("url"))),""===c.get("url")){var e=new TGE_Editor.views.ErrEmbededVideo({model:c,el:b});return void e.render()}switch(c.buildEmbedCode(),d){case"youtube":default:var e=new TGE_Editor.views.YotubeEmbededVideo({model:this.model,el:b});break;case"vimeo":var e=new TGE_Editor.views.VimeoEmbededVideo({model:this.model,el:b});break;case"wistia":var e=new TGE_Editor.views.WistiaEmbededVideo({model:this.model,el:b});break;case"custom":var e=new TGE_Editor.views.CustomEmbededVideo({model:this.model,el:b})}e.render()},renderSettings:function(){this.$("#tge-question-settings").append(this.settingsTemplate({settings:this.model.get("settings")}));var a=this.$("#tge-answer-limits");!0===TVE_Dash.LocalStorage.get("tge_question_settings_toggle")&&a.css("display","flex"),this.$('input[name="form_size"][value="'+this.model.get("settings").get("form_size")+'"]').prop("checked",!0),new TGE_Editor.views.Switcher({model:new TGE_Editor.models.Setting({label:"Required field",key:"req-toggle",value:this.model.get("settings").get("required")}),el:this.$("#tge-required-switcher")}).render().model.on("change:value",function(a){this.model.get("settings").set("required",a.get("value"))},this),new TGE_Editor.views.Accordion({model:new TGE_Editor.models.Setting({label:"Advanced Answer Settings",value:!!TVE_Dash.LocalStorage.get("tge_question_settings_toggle")}),el:this.$("#tge-question-switcher-settings")}).render().model.on("change:value",function(b,c){var d=c?"flex":"none";TVE_Dash.LocalStorage.set("tge_question_settings_toggle",!!c),a.css({display:d}),this.$(".tge-accordion").toggleClass("tge-active",c)},this),this.model.get("settings").on("change:settings.placeholder",function(a){this.$("#tge-open-question-preview").attr("placeholder",a.get("placeholder"))},this),this.model.get("settings").on("change:settings.answer_limits.min.error_message",function(a){this.$("#tge-min-error_message-preview").text(a.get("answer_limits").min.error_message)},this),this.model.get("settings").on("change:settings.form_size",function(a){this.$("#tge-open-question-preview").attr("rows",a.get("form_size"))},this)}}),TGE_Editor.views.FormQuestionDisplayText=TGE_Editor.views.FormQuestion.extend({template:TVE_Dash.tpl("question/form-text")}),TGE_Editor.views.FormQuestionDisplayVideo=TGE_Editor.views.FormQuestion.extend({template:TVE_Dash.tpl("question/form-video"),events:_.extend({},TGE_Editor.views.FormQuestion.prototype.events,{"change #tge-display-settings-url":function(a){var b=this.model.get("display_settings");b.validateUrlBySource(),this.closeDropdowns(),this.renderEmbededVideo(),this.setDisplayOptions(),b.trigger("tge:video:renderOptions")},"click .tge-display-checkbox":"handleAdvancedOptions","change #tge-display-url-source":"setSource"}),render:function(){return this.$el.html(this.template({item:this.model})),this.renderVideoSettings(),this.renderEmbededVideo(),this.model.isOpenEndedType()&&(this.$("#tge-qf-add-answer").hide(),this.renderSettings()),TVE_Dash.data_binder(this),this.renderAnswers(this.model.get("answers")),this.renderImagePicker(this.$("#tge-qf-image-loader")),"personality"===TGE_Editor.quiz.quiz_type&&!1===this.model.isOpenEndedType()&&this.render_weight_switcher(),!1===this.model.isOpenEndedType()&&(this.render_tags_switcher(),this.render_feedback_switcher()),this.checkDisabledThumb(),TVE_Dash.materialize(this.$el),setTimeout(function(a){a.$("input#tge-question-text").first().focus()},10,this),this},setDisplayOptions:function(){var a=this.model.get("source"),b=this.model.get("new_question"),c="object"==typeof TGE_Editor.default_video_options?TGE_Editor.default_video_options:JSON.parse(TGE_Editor.default_video_options);c&&a in c&&1===b&&(this.model.set("options",c[a]),this.model.trigger("tge:video:renderOptions"))},renderVideoSettings:function(){var a=this.model.get("display_settings"),b=this.model;this.settings_view=new TGE_Editor.views.FormVideoDisplaySettings({model:a,el:this.$el.find(".tge-media-prop"),question_model:b}),this.settings_view.render()},setSource:function(a){this.model.set("source",a.currentTarget.value)},handleAdvancedOptions:function(b){"autoplay"===a(b.currentTarget).data("id")&&this.model.trigger(a(b.currentTarget).is(":checked")?"tge:video:disableVideoThumb":"tge:video:enableVideoThumb"),this.model.get("display_settings").buildEmbedCode(),this.renderEmbededVideo()},closeDropdowns:function(){this.$(".tge-display-options-data, .tge-video-style-dropdown, .tge-question-display-type").addClass("tvd-hiddendiv")}}),TGE_Editor.views.FormQuestionDisplayAudio=TGE_Editor.views.FormQuestionDisplayVideo.extend({template:TVE_Dash.tpl("question/form-audio"),render:function(){return TGE_Editor.views.FormQuestionDisplayVideo.prototype.render.call(this),this.model.trigger("tge:video:disableVideoThumb"),this},renderVideoSettings:function(){var a=this.model.get("display_settings");this.settings_view=new TGE_Editor.views.FormAudioDisplaySettings({model:a,el:this.$el.find(".tge-media-prop")}),this.settings_view.render()},setDisplayOptions:function(){var a=this.model.get("audio_source"),b=this.model.get("new_question"),c="object"==typeof TGE_Editor.default_audio_options?TGE_Editor.default_audio_options:JSON.parse(TGE_Editor.default_audio_options);c&&a in c&&1===b&&(this.model.set("options",c[a]),
this.model.trigger("tge:video:renderOptions"))},renderEmbededVideo:function(b){b=b||this.$el.find("#tge-qf-video-loader");var c=this.model instanceof TGE_Editor.models.Audio?this.model:this.model.get("display_settings"),d=c.get("audio_source");if(c instanceof TGE_Editor.models.Audio){if(c.set("url",a.trim(c.get("url"))),""===c.get("url")){var e=new TGE_Editor.views.ErrEmbededAudio({model:c,el:b});return void e.render()}switch(c.buildEmbedCode(),d){case"custom":default:var e=new TGE_Editor.views.CustomEmbededAudio({model:c,el:b});break;case"spotify":var e=new TGE_Editor.views.SpotifyEmbededAudio({model:c,el:b});break;case"soundcloud":var e=new TGE_Editor.views.SoundCloudEmbededAudio({model:c,el:b})}e.render()}},handleAdvancedOptions:function(a){this.model.get("display_settings").buildEmbedCode(),this.renderEmbededVideo()}}),TGE_Editor.views.GeneralQuestion=Backbone.View.extend({template:TVE_Dash.tpl("question/general"),events:{"click .tge-dropdown-type-item":function(b){var c=parseInt(a(b.currentTarget).data("id"));this.form_view.undelegateEvents(),this.setRelatedModel(c),this.handleDropdown(b),this.renderQuestionForm(),TVE_Dash.materialize(this.$el)}},render:function(){return this.$el.html(this.template({item:this.model})),this.setRelatedModel(),this.renderDisplayType(),this.renderQuestionForm(),this.closeDropdowns(),this},closeDropdowns:function(){a(document).click(function(b){a(b.target).is(".tge-display-checkbox, .tge-display-options-data, .tge-vopts-selected-elem, .tge-selected-video-source, #tge-question-type-selector, .tge-selected-video-style, #tge-display-video-options, .tge-vopts-selected-elem")||a(b.target).parents(".tge-display-options-data").length>0||a(".tge-video-source-dropdown, .tge-video-style-dropdown, .tge-display-options-data, .tge-question-display-type").addClass("tvd-hiddendiv")})},setRelatedModel:function(a){void 0!==a&&this.model.resetDisplaySettings(),2===a&&this.model.unset("image");var b=this.model.get("display_settings")instanceof Backbone.Model?this.model.get("display_settings").toDeepJSON():this.model.get("display_settings"),c=b&&b.display_type?b.display_type:0,d="";a=void 0!==a?a:c;var e={};switch(a){case 1:e.type="video",e.source="youtube",d="Video";break;case 2:e.type="audio",e.source="custom",d="Audio";break;case 0:default:e.type="text",d="Text"}b=_.extend({},e,b);var f="function"==typeof TGE_Editor.models[d]?new TGE_Editor.models[d](b):new Backbone.Model(b);if(f.set("display_type",a),void 0!==f.get("new_question")&&1===parseInt(f.get("new_question"))){var g=f.get("video_style");g.selected=TGE_Editor.default_video_style,f.set("video_style",g),f.set("style",g.selected)}f instanceof TGE_Editor.models.Audio&&this.model.set("image",""),f.set("options",f.getOptions()),this.model.set("display_settings",f)},handleDropdown:function(b){var c=a(b.currentTarget).data("id"),d="text";switch(parseInt(c)){case 0:d="text";break;case 1:d="video";break;case 2:d="audio"}a(".tge-question-type-selector").removeClass(function(a,b){return(b.match(/\btge-vicon-\S+/g)||[]).join(" ")}),a(".tge-question-type-selector").addClass("tge-vicon-"+d),a(".tge-question-type-selector").text(this.model.get("display_type_labels")[c]),a(".tge-question-display-type").addClass("tvd-hiddendiv")},renderDisplayType:function(){new TGE_Editor.views.TypeSwitcher({model:this.model,el:this.$el.find(".tge-display-holder")}).render()},renderQuestionForm:function(){var a=this.model.get("display_settings"),b=a.get("display_type");switch(parseInt(b)){case 0:default:this.form_view=new TGE_Editor.views.FormQuestionDisplayText({model:this.model,el:this.$el.find(".tge-q-form-wrapper")});break;case 1:this.form_view=new TGE_Editor.views.FormQuestionDisplayVideo({model:this.model,el:this.$el.find(".tge-q-form-wrapper")});break;case 2:this.form_view=new TGE_Editor.views.FormQuestionDisplayAudio({model:this.model,el:this.$el.find(".tge-q-form-wrapper")})}this.form_view.render()}}),TGE_Editor.views.FormQuestionEdit=TGE_Editor.views.FormQuestion.extend({render:function(){return this.$el.html(this.template({item:this.model})),this.model.get("description")&&this.model.get("description").length&&this.$("#tge-qf-add-description").html(TGE_Editor.t.edit_description),this.model.isOpenEndedType()?(this.$("#tge-qf-add-answer").hide(),this.renderSettings()):(this.render_tags_switcher(),this.render_feedback_switcher()),TVE_Dash.data_binder(this),this.renderAnswers(this.model.get("answers")),this.renderImagePicker(this.$("#tge-qf-image-loader")),"personality"===TGE_Editor.quiz.quiz_type&&!1===this.model.isOpenEndedType()&&this.render_weight_switcher(),this}}),TGE_Editor.views.FormQuestionDisplayTextEdit=TGE_Editor.views.FormQuestionEdit.extend({template:TVE_Dash.tpl("question/form-text")}),TGE_Editor.views.FormQuestionDisplayVideoEdit=TGE_Editor.views.FormQuestionEdit.extend({template:TVE_Dash.tpl("question/form-video"),events:function(){return _.extend({},TGE_Editor.views.FormQuestion.prototype.events,{"change #tge-display-settings-url":function(a){this.model.get("display_settings").validateUrlBySource(),this.closeDropdowns(),this.setDisplayOptions(),this.renderEmbededVideo()},"click .tge-display-checkbox":function(b){"autoplay"===a(b.currentTarget).data("id")&&this.model.trigger(a(b.currentTarget).is(":checked")?"tge:video:disableVideoThumb":"tge:video:enableVideoThumb"),this.model.get("display_settings").buildEmbedCode(),this.renderEmbededVideo()},"change #tge-display-url-source":"setSource"})},render:function(){var a=this.model.get("display_settings");return!1==a instanceof Backbone.Model&&(a=new TGE_Editor.models.Video(a),this.model.set({display_settings:a})),this.$el.html(this.template({item:this.model})),this.renderVideoSettings(),this.renderEmbededVideo(),this.model.isOpenEndedType()&&(this.$("#tge-qf-add-answer").hide(),this.renderSettings()),TVE_Dash.data_binder(this),this.renderAnswers(this.model.get("answers")),this.renderImagePicker(this.$("#tge-qf-image-loader")),"personality"===TGE_Editor.quiz.quiz_type&&!1===this.model.isOpenEndedType()&&this.render_weight_switcher(),!1===this.model.isOpenEndedType()&&(this.render_tags_switcher(),this.render_feedback_switcher()),this.checkDisabledThumb(),TVE_Dash.materialize(this.$el),setTimeout(function(a){a.$("input#tge-question-text").first().focus()},10,this),this},checkDisabledThumb:function(){var a=this.model.get("display_settings"),b=a.get("options");void 0!==a&&void 0!==b.autoplay&&1===parseInt(b.autoplay.value)&&this.model.trigger("tge:video:disableVideoThumb")},setDisplayOptions:function(){var a=this.model.get("source"),b=this.model.get("new_question"),c="object"==typeof TGE_Editor.default_video_options?TGE_Editor.default_video_options:JSON.parse(TGE_Editor.default_video_options);c&&a in c&&1===b&&(this.model.set("options",c[a]),this.model.trigger("tge:video:renderOptions"))},renderVideoSettings:function(){var a=this.model.get("display_settings"),b=this.model;this.settings_view=new TGE_Editor.views.FormVideoDisplaySettings({model:a,el:this.$el.find(".tge-media-prop"),question_model:b}),this.settings_view.render()},toggleStyleOptions:function(){this.$(".tge-video-style-dropdown").toggleClass("tvd-hiddendiv")},setSource:function(a){this.model.set("source",a.currentTarget.value)},closeDropdowns:function(){this.$(".tge-display-options-data, .tge-video-style-dropdown, .tge-question-display-type").addClass("tvd-hiddendiv")}}),TGE_Editor.views.FormQuestionDisplayAudioEdit=TGE_Editor.views.FormQuestionDisplayAudio.extend({template:TVE_Dash.tpl("question/form-audio")}),TGE_Editor.views.QuestionVideoStyles=Backbone.View.extend({template:TVE_Dash.tpl("question/video-styles"),events:{"click #tge-display-video-style":"toggleStyles","click .tge-video-monitor-image":"saveStyle"},render:function(){return this.$el.html(this.template({item:this.model.get("video_style")})),this.renderElements(),this},renderElements:function(){var a=this.model.get("video_style"),b=TVE_Dash.tpl("question/_video-style");_.each(a.labels,function(c,d){var e={id:d,item:c,selected:a.selected};this.$(".tge-video-style-dropdown").append(b({item:e}))},this)},toggleStyles:function(a){this.closeDropdowns(),this.$(".tge-video-style-dropdown").toggleClass("tvd-hiddendiv")},saveStyle:function(b){this.selectCurrentElem(b);var c=this.model.get("video_style");c.selected=a(b.currentTarget).data("id"),a(this.el).find(".tge-selected-video-style").html(c.labels[a(b.currentTarget).data("id")]),this.model.set("style",c.selected),this.model.set("video_style",c),this.model.set("new_question",0),this.model.trigger("tge:video:renderEmbedVideo",b)},selectCurrentElem:function(a){this.$(a.currentTarget).siblings().removeClass("tge-video-style-active"),this.$(a.currentTarget).addClass("tge-video-style-active")},closeDropdowns:function(){a(".tge-video-source-dropdown, .tge-display-options-data, .tge-question-display-type").addClass("tvd-hiddendiv")}}),TGE_Editor.views.QuestionVideoSource=TGE_Editor.views.QuestionVideoStyles.extend({template:TVE_Dash.tpl("question/video-source"),events:{"click #tge-display-video-source":function(){this.model.trigger("tge:video:set:placeholderUrl"),this.toggleStyles()},"click .tge-video-source-type":"saveSource"},initialize:function(a){a.question_model instanceof Backbone.Model&&(this.question_model=a.question_model)},render:function(){var a={selected:this.model.get("source"),labels:this.model.get("source_labels")};return this.$el.html(this.template({item:a})),this.renderElements(),this},renderElements:function(){var a=this.model.get("source_labels"),b=TVE_Dash.tpl("question/_video-source"),c=this.model.get("source");_.each(a,function(a,d){var e={id:d,item:a,selected:c};this.$(".tge-video-source-dropdown").append(b({item:e}))},this)},toggleStyles:function(a){this.closeDropdowns(),this.$(".tge-video-source-dropdown").toggleClass("tvd-hiddendiv")},saveSource:function(b){this.toggleActiveElem(b);var c=a(b.currentTarget).data("id"),d=this.model.get("source_labels"),e=this.model instanceof TGE_Editor.models.Audio?"audio_source":"source";this.optionsByVideoSource(c),a(this.el).find(".tge-selected-video-source").html(d[c]),this.model.set("url",""),this.model.set(e,c),this.model.trigger("tge:video:resetUrl",b),this.model.trigger("tge:video:renderEmbedVideo",b),this.handleSourceColor(),this.setDisplayOptions(),this.toggleMediaSelect(c),this.checkDisabledThumb()},checkDisabledThumb:function(){var a=this.model.get("display_settings")instanceof Backbone.Model?this.model.get("display_settings"):this.model,b=a.getOptions(),c=void 0!==b.autoplay?parseInt(b.autoplay.value):"";this.question_model.trigger(1===c?"tge:video:disableVideoThumb":"tge:video:enableVideoThumb"),1===c&&(a.set("thumb",""),this.question_model.set("image",""),this.question_model.trigger("tge:video:removeVideoThumb"))},optionsByVideoSource:function(a){var b=this.model.getMediaOptionsBySource(a);this.model.set("options",b),this.model.trigger("tge:video:renderOptions")},toggleMediaSelect:function(b){"custom"===b?a(".tge-select-media-video").removeClass("tvd-hiddendiv"):a(".tge-select-media-video").addClass("tvd-hiddendiv")},handleSourceColor:function(){"youtube"===this.model.get("source")||"custom"===this.model.get("source")?a(".tqb-video-color-container").hide():a(".tqb-video-color-container").show()},closeDropdowns:function(){a(".tge-video-style-dropdown, .tge-display-options-data, .tge-question-display-type").addClass("tvd-hiddendiv")},setDisplayOptions:function(){var a=this.model.get("source"),b=this.model.get("new_question"),c="object"==typeof TGE_Editor.default_video_options?TGE_Editor.default_video_options:JSON.parse(TGE_Editor.default_video_options);c&&a in c&&1===b&&(this.model.set("options",c[a]),this.model.trigger("tge:video:renderOptions"))},toggleActiveElem:function(a){this.$(".tge-video-source-type").removeClass("tge-video-source-type-active"),this.$(a.currentTarget).addClass("tge-video-source-type-active")}}),TGE_Editor.views.QuestionAudioSource=TGE_Editor.views.QuestionVideoSource.extend({render:function(){var a={selected:this.model.get("audio_source"),labels:this.model.get("source_audio_labels")};return this.$el.html(this.template({item:a})),this.renderElements(),this},renderElements:function(){var a=this.model.get("source_audio_labels"),b=TVE_Dash.tpl("question/_video-source"),c=this.model.get("audio_source");_.each(a,function(a,d){var e={id:d,item:a,selected:c};this.$(".tge-video-source-dropdown").append(b({item:e}))},this)},saveSource:function(b){this.toggleActiveElem(b);var c=b.currentTarget.dataset.id,d=this.model.get("source_audio_labels"),e=this.model instanceof TGE_Editor.models.Audio?"audio_source":"source";this.model.set(e,c),this.model.set("url",""),this.optionsByVideoSource(c),a(this.el).find(".tge-selected-video-source").html(d[c]),this.model.trigger("tge:video:resetUrl",b),this.model.trigger("tge:video:renderEmbedVideo",b),this.setDisplayOptions(),this.toggleMediaSelect(c)},setDisplayOptions:function(){var a=this.model.get("audio_source"),b=this.model.get("new_question"),c="object"==typeof TGE_Editor.default_audio_options?TGE_Editor.default_audio_options:JSON.parse(TGE_Editor.default_audio_options);c&&a in c&&1===b&&(this.model.set("options",c[a]),this.model.trigger("tge:video:renderOptions"))},optionsByVideoSource:function(a){var b=this.model.getMediaOptionsBySource(a);this.model.set("options",b),this.model.trigger("tge:video:renderOptions")}}),TGE_Editor.views.FormVideoDisplaySettings=TGE_Editor.views.FormQuestionEdit.extend({template:TVE_Dash.tpl("question/video-display-settings"),events:{"change #tge-display-url-source":function(a){this.closeDropdowns(),this.model.set("source",a.currentTarget.value)},"click #tge-display-video-options":function(){this.closeDropdowns(),this.toggleOptions()},"click .tge-display-checkbox":"toggleChecked","click .tge-select-media-video":"selectWpMedia"},initialize:function(b){var c=this;b.question_model instanceof Backbone.Model&&(this.question_model=b.question_model),this.listenTo(this.model,"change:source",this.renderOptions),this.model.on("tge:video:renderEmbedVideo",function(b){c.renderEmbededVideo(a("#tge-qf-video-loader"))}),this.model.on("tge:video:resetUrl",function(){c.$("#tge-display-settings-url").removeClass("tvd-invalid"),c.resetUrl()}),this.model.on("tge:video:renderOptions",function(a){c.renderOptions()}),this.model.on("tge:video:invalid:url",function(a){c.$("#tge-display-settings-url").addClass("tvd-invalid"),TVE_Dash.err(TVE_Dash.sprintf(c.model instanceof TGE_Editor.models.Audio?TGE_Editor.t.add_valid_audio_url:TGE_Editor.t.add_valid_video_url,[TVE_Dash.upperFirst(c.model.get(c.model instanceof TGE_Editor.models.Audio?"audio_source":"source"))]),3e3),c.model.set("url",""),c.renderEmbededVideo(),c.renderOptions(),c.$("input#tge-display-settings-url").first().focus()}),this.model.on("tge:video:valid:url",function(a){c.$("#tge-display-settings-url").removeClass("tvd-invalid"),c.$(".tge-vopts-selected-elem").removeClass("tge-options-disabled")}),this.model.on("tge:video:valid:url:focus",function(a){c.$("input#tge-display-settings-url").first().focus()}),this.model.on("tge:video:set:placeholderUrl",function(){c.setUrlPlaceholder()})},allowedMimeTypes:{asf:"video/x-ms-asf",asx:"video/x-ms-asf",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wm:"video/x-ms-wm",avi:"video/avi",divx:"video/divx",flv:"video/x-flv",mov:"video/quicktime",qt:"video/quicktime",mpeg:"video/mpeg",mpg:"video/mpeg",mpe:"video/mpeg",mp4:"video/mp4",m4v:"video/mp4",ogv:"video/ogg",webm:"video/webm",mkv:"video/x-matroska"},render:function(){return this.$("#tge-display-url-source").removeClass("tge-invalid"),this.$el.html(this.template({item:this.model})),this.initColorPicker(),TVE_Dash.data_binder(this),TVE_Dash.materialize(this.$el),this.renderSource(),this.model instanceof TGE_Editor.models.Audio||this.renderStyles(),this.renderOptions(),this.handleSourceColor(),this},setUrlPlaceholder:function(){var a=this.model.getUrlPlaceholder();this.$(".tge-media-url-name").text(a)},selectWpMedia:function(){this.handleMedia()},handleMedia:function(){var b=this,c=wp.media({title:TGE_Editor.t.media.video_title,multiple:!1,frame:"select",library:{type:["video"]}});c.on("select",function(){var d=c.state().get("selection").first().toJSON(),e=d.subtype;if("string"==typeof b.allowedMimeTypes[e])return b.question_model instanceof Backbone.Model&&b.model.set("thumb",b.question_model.get("image")),b.$(".tge-select-media-video-err").empty(),b.model.set("url",d.url),b.renderEmbededVideo(a("#tge-qf-video-loader")),b.model.trigger("tge:video:valid:url",b),void b.model.trigger("tge:video:valid:url:focus",b);b.$(".tge-select-media-video-err").html(TGE_Editor.t.media.video_error)}),c.open()},renderStyles:function(){new TGE_Editor.views.QuestionVideoStyles({model:this.model,el:this.$el.find(".tge-display-style-container")}).render()},resetUrl:function(){this.$("#tge-display-settings-url").val("")},renderSource:function(){new TGE_Editor.views.QuestionVideoSource({model:this.model,el:this.$el.find(".tge-display-url-source"),question_model:this.question_model}).render()},renderOptions:function(){var a=TVE_Dash.tpl("question/_checkbox"),b=0!==Object.keys(this.model.get("options")).length?this.model.get("options"):this.model.getMediaOptionsBySource(this.model.get("source")),c=this.question_model.get("image");this.optionsVisibility(),this.model.set("options",b),this.$(".tge-display-options-data").empty(),_.each(b,function(b){if(!1!==this.model.hasOption(b.id)){var d="autoplay"===b.id&&TGE_Editor.t.media.autoplay_tooltip,e=!1;"autoplay"===b.id&&c instanceof Backbone.Model&&(e=!0),this.$(".tge-display-options-data").append(a({item:b,tooltip:d,disabled:e}))}},this)},optionsVisibility:function(){""===this.model.get("url")?this.$(".tge-vopts-selected-elem").addClass("tge-options-disabled"):this.$(".tge-vopts-selected-elem").removeClass("tge-options-disabled")},handleSourceColor:function(){"youtube"===this.model.get("source")||"custom"===this.model.get("source")?this.$(".tqb-video-color-container").hide():this.$(".tqb-video-color-container").show()},toggleOptions:function(){this.$(".tge-vopts-selected-elem").hasClass("tge-options-disabled")||this.$(".tge-display-options-data").toggleClass("tvd-hiddendiv")},initColorPicker:function(){var a=this;this.$color_picker=this.$(".tqb-video-color").spectrum({containerClassName:"tqb-video-color-holder tqb-color-picker",showInitial:!0,showInput:!0,allowEmpty:!1,showButtons:!0,cancelText:TGE_Editor.t.media.cancel,preferredFormat:"hex",change:function(b){a.model.set("color",null!==b?b.toHexString():""),a.$("#tqb-video-color-overlay-code").val(null!==b?b.toHexString():"#000000"),a.model.buildEmbedCode(),a.model.trigger("tge:video:renderEmbedVideo")},move:function(b){a.$("#tqb-video-color-overlay-code").val(null!==b?b.toHexString():"#000000")},beforeShow:function(b){a.closeAllDropdowns()}})},toggleChecked:function(b){var c=a(b.currentTarget).is(":checked"),d=a(b.currentTarget).data("id"),e=this.model.get("options");"autoplay"===d&&this.model.set("show_thumb",!0===c?0:1),e[d].value=!0===c?1:0,this.model.set({options:e})},closeDropdowns:function(){a(".tge-video-source-dropdown, .tge-video-style-dropdown, .tge-question-display-type").addClass("tvd-hiddendiv")},closeAllDropdowns:function(){a(".tge-video-source-dropdown, .tge-video-style-dropdown, .tge-question-display-type, .tge-display-options-data").addClass("tvd-hiddendiv")}}),TGE_Editor.views.FormAudioDisplaySettings=TGE_Editor.views.FormVideoDisplaySettings.extend({template:TVE_Dash.tpl("question/audio-display-settings"),initialize:function(){TGE_Editor.views.FormVideoDisplaySettings.prototype.initialize.apply(this,arguments)},renderSource:function(){new TGE_Editor.views.QuestionAudioSource({model:this.model,el:this.$el.find(".tge-display-url-source")}).render()},renderStyles:function(){},initColorPicker:function(){},toggleChecked:function(b){var c=a(b.currentTarget).is(":checked"),d=a(b.currentTarget).data("id"),e=this.model.get("options");e[d].value=!0===c?1:0,this.model.set({options:e})},renderEmbededVideo:function(b){b=b||this.$el.find("#tge-qf-video-loader");var c=this.model.get("audio_source");if(this.model.set("url",a.trim(this.model.get("url"))),""===this.model.get("url")){var d=new TGE_Editor.views.ErrEmbededAudio({model:this.model,el:b});return void d.render()}switch(c){case"custom":default:var d=new TGE_Editor.views.CustomEmbededAudio({model:this.model,el:b});break;case"spotify":var d=new TGE_Editor.views.SpotifyEmbededAudio({model:this.model,el:b});break;case"soundcloud":var d=new TGE_Editor.views.SoundcloudEmbededAudio({model:this.model,el:b})}d.render()},handleMedia:function(){var b=this,c=wp.media({title:TGE_Editor.t.media.video_title,multiple:!1,frame:"select",library:{type:["audio"]}});c.on("select",function(){var d=c.state().get("selection").first().toJSON(),e=d.subtype;if("string"==typeof b.model.allowedMimeTypes[e])return b.$(".tge-select-media-video-err").empty(),b.model.set("url",d.url),b.renderEmbededVideo(a("#tge-qf-video-loader")),b.model.trigger("tge:video:valid:url",b),void b.model.trigger("tge:video:valid:url:focus",b);b.$(".tge-select-media-video-err").html(TGE_Editor.t.media.video_error)}),c.open()},renderOptions:function(){var a=TVE_Dash.tpl("question/_checkbox"),b=0!==Object.keys(this.model.get("options")).length?this.model.get("options"):this.model.getMediaOptionsBySource(this.model.get("audio_source"));this.optionsVisibility(),this.toggleSpotifyTooltip(),this.model.set("options",b),this.$(".tge-display-options-data").empty(),_.each(b,function(b){!1!==this.model.hasOption(b.id)&&this.$(".tge-display-options-data").append(a({item:b,tooltip:!1,disabled:!1}))},this)},toggleSpotifyTooltip:function(){this.$("#tge-display-video-options").removeClass("tvd-tooltipped"),this.model.sourceIsSpotify()&&this.$("#tge-display-video-options").addClass("tvd-tooltipped").attr("data-tooltip",TGE_Editor.t.media.spotify_options_tooltip).attr("data-position","top")},optionsVisibility:function(){""===this.model.get("url")||"spotify"===this.model.get("audio_source")?this.$(".tge-vopts-selected-elem").addClass("tge-options-disabled"):this.$(".tge-vopts-selected-elem").removeClass("tge-options-disabled")}}),TGE_Editor.views.GeneralQuestionEdit=TGE_Editor.views.GeneralQuestion.extend({renderQuestionForm:function(){var a=this.model.get("display_settings"),b=a.get("display_type");switch(parseInt(b)){case 0:default:this.form_view=new TGE_Editor.views.FormQuestionDisplayTextEdit({model:this.model,el:this.$el.find(".tge-q-form-wrapper")});break;case 1:this.form_view=new TGE_Editor.views.FormQuestionDisplayVideoEdit({model:this.model,el:this.$el.find(".tge-q-form-wrapper")});break;case 2:this.form_view=new TGE_Editor.views.FormQuestionDisplayAudioEdit({model:this.model,el:this.$el.find(".tge-q-form-wrapper")})}this.form_view.render()}}),TGE_Editor.views.FormAnswer=Backbone.View.extend({className:"tvd-white tge-answer "+("personality"===TGE_Editor.quiz.quiz_type?"tge-personality-answer":""),events:{"click .tvd-icon-trash-o":function(){this.collection.remove(this.model),this.remove()}},initialize:function(a){this.question=a.question,this.listenTo(TGE_Editor.globals.settings.get_model("display_weight"),"change:value",this.toggle_points),this.listenTo(TGE_Editor.globals.settings.get_model("display_tags"),"change:value",this.toggle_tags),this.listenTo(this.model,"change:is_right",function(a){a.attributes.is_right=!0===a.get("is_right")?1:0,a.attributes.points=1===a.get("is_right")?1:0}),this.listenTo(this.model,"change:points",function(){this.$('input[data-bind="points"]').removeClass("tvd-invalid tvd-tooltipped")})},toggle_tags:function(a){a.get("value")?this.tags_view.$el.show():this.tags_view.$el.hide()},toggle_points:function(a,b){this._get_points_column().css({display:b?"block":"none"})},toggle_feedback:function(){this.model.get("feedback")&&0===this.model.get("feedback").length&&this.$("#tge-question-feedback").val(""),!0===this.question.display_feedback()?this.feedback_view.$el.show():this.feedback_view.$el.hide()},render:function(){return this.$el.html(this.template({item:this.model})),"right_wrong"===TGE_Editor.quiz.quiz_type?this._render_right_wrong_input():"survey"!==TGE_Editor.quiz.quiz_type&&this._render_points_input(),"personality"===TGE_Editor.quiz.quiz_type&&this.render_results_options(),this.render_tags(),this.render_feedback_form(),TVE_Dash.data_binder(this),this},render_tags:function(){this.tags_view=new TGE_Editor.views.TagsView({model:this.model,el:this.$(".tge-tags-column")}),this.tags_view.render(),this.toggle_tags(TGE_Editor.globals.settings.get_model("display_tags"))},render_feedback_form:function(){this.feedback_view=new TGE_Editor.views.FeedbackView({model:this.model,el:this.$(".tge-feedback-column")}),this.feedback_view.render(),this.toggle_feedback()},render_results_options:function(){this.results_view=new TGE_Editor.views.QuizResults({collection:new Backbone.Collection(TGE_Editor.quiz.results),model:this.model}),this._get_points_column().before(this.results_view.render().$el),TGE_Editor.globals.settings.get_model("display_weight").is_checked()?this._get_points_column().css({display:"block"}):this._get_points_column().css({display:"none"})},_render_points_input:function(){var a=TVE_Dash.tpl("answer/form/points");this._get_points_column().html(a({item:this.model}))},_render_right_wrong_input:function(){var a=TVE_Dash.tpl("answer/form/right_wrong");this._get_points_column().html(a({item:this.model}))},_get_points_column:function(){return this.$points_column||(this.$points_column=this.$(".tge-points-column")),this.$points_column},_set_wrong:function(a){a.each(function(a){a.attributes.is_right=0,a.attributes.points=0})}}),TGE_Editor.views.FormAnswerImage=TGE_Editor.views.FormAnswer.extend({template:TVE_Dash.tpl("answer/form/image"),render:function(){return TGE_Editor.views.FormAnswer.prototype.render.apply(this,arguments),this.renderImagePicker(this.$(".tge-image-loader")),this},renderImagePicker:function(a){new TGE_Editor.views.ImagePickereAnswer({model:this.model,el:a}).render()}}),TGE_Editor.views.FormAnswerButton=TGE_Editor.views.FormAnswer.extend({template:TVE_Dash.tpl("answer/form/button"),events:_.extend({},TGE_Editor.views.FormAnswer.prototype.events,{})}),TGE_Editor.views.ImagePicker=Backbone.View.extend({template:TVE_Dash.tpl("image/form"),events:{"click .tge-add-image, .tge-image-placeholder":"open_media","click .tge-remove-image":"remove","click .tge-change-image":"open_media"},initialize:function(){var a=this;this.model.on("tge:video:disableVideoThumb",function(b){a.disableVideoThumb()}),this.model.on("tge:video:enableVideoThumb",function(b){a.enableVideoThumb()}),this.model.on("tge:video:removeVideoThumb",function(b){a.remove()})},render:function(){var a=this.model.get("display_settings"),b=a instanceof Backbone.Model?a.get("type"):"";return this.$el.html(this.template({item:this.model,display_type:b})),this.$form=this.$(".tge-image-form"),this.$buttonAdd=this.$(".tge-add-image"),this.$buttonRemove=this.$(".tge-remove-image"),this.$buttonChange=this.$(".tge-change-image"),this.$placeholder=this.$(".tge-image-placeholder"),this.load_image(),TVE_Dash.data_binder(this),this},open_media:function(){var a=this,b=wp.media({title:TGE_Editor.t.media.question_title});b.on("select",function(){var c=b.state().get("selection").first().toJSON();c.sizes.thumbnail||(c.sizes.thumbnail=c.sizes.full),a.$placeholder.removeClass("tvd-invalid tvd-tooltipped"),a.model.set("image",new TGE_Editor.models.Image(c));var d=a.model.get("display_settings");void 0!==d&&d instanceof TGE_Editor.models.Video&&(d.set("thumb",new TGE_Editor.models.Image(c)),d.set("show_thumb",1),a.model.trigger("tge:video:renderEmbed"),a.model.trigger("tge:video:disableAutoplay")),a.load_image()}),b.open()},remove:function(){this.$placeholder.css({"background-image":"","background-size":""});var a=this.model.get("display_settings")instanceof TGE_Editor.models.Video&&this.model.get("display_settings");this.$form.removeClass("tge-has-image"),this.model.set("image",""),a&&(a.set("thumb",""),a.set("show_thumb",0),this.model.trigger("tge:video:renderEmbed"),this.model.trigger("tge:video:enableAutoplay")),this.$buttonAdd.css({display:"block"})},load_image:function(){this.model.get("image")&&this.model.get("image").get_thumb()&&(this.$placeholder.css({"background-image":"url("+this.model.get("image").get_thumb()+")","background-size":"cover"}),this.$form.addClass("tge-has-image"),this.$buttonAdd.css({display:"none"}))},disableVideoThumb:function(){this.$el.find(".tge-image-form ").addClass("tge-disabled-thumb")},enableVideoThumb:function(){this.$el.find(".tge-image-form ").removeClass("tge-disabled-thumb")}}),TGE_Editor.views.VideoImageOverlay=Backbone.View.extend({template:TVE_Dash.tpl("video/image-overlay"),events:{"click .tqb_video_overlay_image":"hideOverlayImage"},render:function(){var a=this.model.get("thumb")instanceof Backbone.Model&&this.model.get("thumb"),b=a?a.get("url"):"",c=this.model.get("source");return this.$(".tqb-video-container-responsive").prepend(this.template({source:c,url:b})),this},hideOverlayImage:function(a){this.model.set("show_thumb",0),this.$(".tqb_video_overlay_image").addClass("tvd-hiddendiv"),this.model.trigger("tge:video:renderEmbedVideo")}}),TGE_Editor.views.MediaEmbeded=Backbone.View.extend({render:function(){return TVE_Dash.showLoader(),this.$el.html(this.template({item:this.model})),TVE_Dash.hideLoader(),this},renderVideoImageOverlay:function(){var a=this.model instanceof TGE_Editor.models.Video?this.model:this.model.get("display_settings");this.model.get("image")instanceof Backbone.Model&&a.set("thumb",this.model.get("image"));var b=this.model.get("image")instanceof Backbone.Model?this.model.get("image"):a.get("thumb"),c=a.get("show_thumb");if(void 0===c||0===parseInt(c)||!1==b instanceof Backbone.Model)return!1;new TGE_Editor.views.VideoImageOverlay({model:a,el:this.$el}).render()}}),TGE_Editor.views.CustomEmbededVideo=TGE_Editor.views.MediaEmbeded.extend({template:TVE_Dash.tpl("video/custom"),allowedMimeTypes:{asf:"video/x-ms-asf",asx:"video/x-ms-asf",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wm:"video/x-ms-wm",avi:"video/avi",divx:"video/divx",flv:"video/x-flv",mov:"video/quicktime",qt:"video/quicktime",mpeg:"video/mpeg",mpg:"video/mpeg",mpe:"video/mpeg",mp4:"video/mp4",m4v:"video/mp4",ogv:"video/ogg",webm:"video/webm",mkv:"video/x-matroska"},render:function(){var a=this.media_mime(),b=this.model instanceof TGE_Editor.models.Video?this.model:this.model.get("display_settings");return this.$el.html(this.template({mime:a,item:b})),this.renderVideoImageOverlay(),TVE_Dash.data_binder(this),this},media_mime:function(){var a=this.model instanceof TGE_Editor.models.Video?this.model:this.model.get("display_settings"),b=a.get("url").split(".").pop().toLowerCase();return"string"==typeof this.allowedMimeTypes[b]?this.allowedMimeTypes[b]:""}}),TGE_Editor.views.CustomEmbededAudio=TGE_Editor.views.CustomEmbededVideo.extend({template:TVE_Dash.tpl("audio/custom"),allowedMimeTypes:{mp3:"audio/mpeg",m4a:"audio/mpeg",m4b:"audio/mpeg",ra:"audio/x-realaudio",ram:"audio/x-realaudio",wav:"audio/wav",ogg:"audio/ogg",oga:"audio/ogg",mid:"audio/midi",midi:"audio/midi",wma:"audio/x-ms-wma",wax:"audio/x-ms-wax",mka:"audio/x-matroska"},render:function(){var a=this.media_mime(),b=this.model instanceof TGE_Editor.models.Question?this.model.get("display_settings"):this.model;return this.$el.html(this.template({mime:a,item:b})),TVE_Dash.data_binder(this),this}}),TGE_Editor.views.YotubeEmbededVideo=TGE_Editor.views.MediaEmbeded.extend({template:TVE_Dash.tpl("video/youtube"),render:function(){var a=this.model instanceof TGE_Editor.models.Video?this.model:this.model.get("display_settings");return a.buildEmbedCode(),TVE_Dash.showLoader(),this.$el.html(this.template({item:a})),this.renderVideoImageOverlay(),TVE_Dash.hideLoader(),this}}),TGE_Editor.views.SpotifyEmbededAudio=TGE_Editor.views.MediaEmbeded.extend({template:TVE_Dash.tpl("audio/spotify"),render:function(){
this.model.buildEmbedCode();var a="//open.spotify.com/embed"+this.model.get("video_id");return TVE_Dash.showLoader(),this.$el.html(this.template({item:this.model,src:a})),TVE_Dash.hideLoader(),this}}),TGE_Editor.views.ErrEmbededVideo=TGE_Editor.views.MediaEmbeded.extend({template:TVE_Dash.tpl("video/_err"),render:function(){return TVE_Dash.showLoader(),this.model.buildEmbedCode(),this.$el.html(this.template({item:this.model})),TVE_Dash.hideLoader(),this}}),TGE_Editor.views.ErrEmbededAudio=TGE_Editor.views.ErrEmbededVideo.extend({template:TVE_Dash.tpl("audio/_err")}),TGE_Editor.views.WistiaEmbededVideo=TGE_Editor.views.MediaEmbeded.extend({template:TVE_Dash.tpl("video/wistia"),render:function(){var a=this.model instanceof TGE_Editor.models.Video?this.model:this.model.get("display_settings");return TVE_Dash.showLoader(),a.buildEmbedCode(),this.$el.html(this.template({item:a})),this.renderVideoImageOverlay(),TVE_Dash.hideLoader(),this}}),TGE_Editor.views.VimeoEmbededVideo=TGE_Editor.views.MediaEmbeded.extend({template:TVE_Dash.tpl("video/vimeo"),render:function(){var a=this.model instanceof TGE_Editor.models.Video?this.model:this.model.get("display_settings");return TVE_Dash.showLoader(),a.buildEmbedCode(),this.$el.html(this.template({item:a})),this.renderVideoImageOverlay(),TVE_Dash.hideLoader(),this}}),TGE_Editor.views.SoundCloudEmbededAudio=TGE_Editor.views.MediaEmbeded.extend({template:TVE_Dash.tpl("audio/soundcloud")}),TGE_Editor.views.ImagePickereAnswer=TGE_Editor.views.ImagePicker.extend({template:TVE_Dash.tpl("image/answer")}),TGE_Editor.views.QuizResults=Backbone.View.extend({className:"tge-category-field",template:TVE_Dash.tpl("quiz/responses"),render:function(){return this.$el.html(this.template({item:this.model})),this.$select=this.$("select"),this.collection.each(function(b,c,d){var e=a("<option/>");e.val(b.get("id")),e.text(b.get("text")),this.model.get("result_id")===b.get("id")&&e.attr("selected","selected"),this.$select.append(e)},this),0==this.model.get("result_id")&&this.$select.find('option[value="0"]').attr("selected","selected"),this}}),TGE_Editor.views.QuestionView=Backbone.View.extend({tagName:"li",className:"tvd-collection-item tge-q-item",template:TVE_Dash.tpl("question/item"),events:{click:"onClick"},render:function(){return this.$el.html(this.template({item:this.model})),this.$el.attr("id","tge-question-"+this.model.get("id")),this.$el.css({"border-left-width":2*this.model.get("level")+"px"}),this.model.attributes.rendered=!0,this},highlight_callView:function(a){var b={highlighter:{name:"addClass",options:{className:"tge-opacity"}}};a.highlight(".question-body",b),setTimeout(function(){a.unhighlight(".question-body",b)},150)},onClick:function(){var a=tge_app_view.paper.findViewByModel(this.model.get("id")),b=tge_app_view.graph.getCell(this.model.get("id")),c=tge_app_view.$el.scrollLeft(),d=tge_app_view.$el.scrollTop(),e=this.model.get("position").y-(tge_app_view.$el.height()-b.get("size").height)/2,f=this.model.get("position").x-(tge_app_view.$el.width()-b.get("size").width)/2,g=TGE_Editor.const.paper.size.width/TGE_Editor.const.navigator.size.width,h=TGE_Editor.const.paper.size.height/TGE_Editor.const.navigator.size.height;if(!0===tge_app_view.scrolling||d===e&&c===f)return void this.highlight_callView(a);var i=this,j=e/h,k=f/g;tge_app_view.$nav_handler.animate({top:j<0?0:j,left:k<0?0:k}),tge_app_view.scrolling=!0,tge_app_view.$el.animate({scrollTop:e+"px",scrollLeft:f+"px"},600,"swing",function(){i.highlight_callView(a),tge_app_view.scrolling=!1})}}),TGE_Editor.views.Switcher=Backbone.View.extend({template:TVE_Dash.tpl("question/switcher"),events:{"change input":function(){this.model.set("value",!this.model.attributes.value)}},render:function(){return this.$el.html(this.template({item:this.model})),this}}),TGE_Editor.views.Accordion=TGE_Editor.views.Switcher.extend({template:TVE_Dash.tpl("question/accordion"),events:{"click .tge-accordion":function(){this.model.set("value",!this.model.get("value"))}}}),TGE_Editor.views.TagsSwitcher=TGE_Editor.views.Switcher.extend({template:TVE_Dash.tpl("question/tags-switcher"),initialize:function(){this.listenTo(this.model,"change:value",function(){this.toggle_texts(!0)})},render:function(){return TGE_Editor.views.Switcher.prototype.render.apply(this,arguments),this.toggle_texts(),this},toggle_texts:function(b){var c=this.model.get("value"),d=this.$(".tvd-switch").first(),e=c?TGE_Editor.t.tags_switcher_off_tooltip:TGE_Editor.t.tags_switcher_on_tooltip,f=c?TGE_Editor.t.tags_switcher_on_toast:TGE_Editor.t.tags_switcher_off_toast,g=c?"green accent-5":"yellow accent-5";d.attr("data-tooltip",e),b&&(a(".tvd-toast").remove(),Materialize.toast(f,3e4,"tvd-toast tvd-pointer tge-tags-toast "+g,function(){},"bottom"),a(".tvd-toast").click(function(b){a(this).remove(),b.stopPropagation()}))}}),TGE_Editor.views.TagsView=Backbone.View.extend({template:TVE_Dash.tpl("answer/tags"),render:function(){this.$el.html(this.template({item:this.model}));var a=this.$("input");return this.$chips=a.materialtags({maxTags:5,trimValue:!0,confirmKeys:[9,13,44,188]}),this}}),TGE_Editor.views.FeedbackView=Backbone.View.extend({template:TVE_Dash.tpl("answer/feedback"),render:function(){return this.$el.html(this.template({item:this.model})),this}}),TGE_Editor.views.ProgressBar=Backbone.View.extend({template:TVE_Dash.tpl("quiz/progress-bar"),render:function(){return this.$el.html(this.template({model:this.model})),new TGE_Editor.views.ProgressPreview({model:this.model,el:this.$(".tqb-progress-bar-holder")}).render(),this}}),TGE_Editor.views.ProgressBarOptions=Backbone.View.extend({template:TVE_Dash.tpl("quiz/progress-bar/options"),events:{"change #tqb-progress-bar-type":function(){this.$("#tqb_progress_label").val(this.model.getDefaultLabel()),this.model.set({percent_type:this.$("#tqb-progress-bar-type").val()},{silent:!0}),this.model.set({label_text:this.model.getDefaultLabel()}),this.$(".tqb-default-percentage").html(this.model.getPercentToDisplay()+"%")},"change #tqb-progress-bar-position":function(){this.model.set({progress_position:this.$("#tqb-progress-bar-position").val()},{silent:!0})}},render:function(){return this.$el.html(this.template({model:this.model})),this.$("#tqb-progress-bar-type").val(this.model.get("percent_type")),this.$("#tqb-progress-bar-position").val(this.model.get("progress_position")),this}}),TGE_Editor.views.ProgressPreview=Backbone.View.extend({template:function(a){return TVE_Dash.tpl("quiz/progress-bar/skin/"+this.model.getTemplateId())(a)},render:function(){return this.$el.html(this.template({model:this.model,remaining:20,estimatedProgress:20})),this.$(".tqb-progress-completed").css("background-color",this.model.get("fill_color")),this.$(".tqb-progress-label").css("color",this.model.get("label_color")),this.$(".tqb-progress-label, .tqb-next-item, .tqb-remaining-progress").css("font-size",parseInt(this.model.get("font_size"))),this.$(".tqb-next-item").css("background-color",this.model.get("next_step_color")),this.$(".tqb-remaining-progress").css("background-color",this.model.get("background_color")),this}})})}(jQuery),joint.shapes.tge={},joint.shapes.tge.Question=joint.dia.Element.extend({markup:'<g class="rotatable"><g class="scalable"><rect class="question-body"/></g><text class="question-text"/><image class="question-image"/></g>',portMarkup:'<circle class="port-body" r="7" fill="gray" />',toolsMarkup:'<g class="tge-question-tools"><image class="tge-remove-tool" width="13" height="14"/><image class="tge-edit-tool" width="14" height="15"/><image class="tge-duplicate-tool" width="14" height="14"/></g>',defaults:joint.util.deepSupplement({position:{x:0,y:0},type:"tge.Question",attrs:{".":{magnet:!1},".question-body":{rx:"4px",ry:"4px",fill:"#595c60",filter:{name:"dropShadow",args:{dx:2,dy:2,blur:3}}},".question-image":{x:0,y:0,width:TGE_Editor.const.question.image.size.width,preserveAspectRatio:"xMidYMid slice"},".question-text":{ref:".question-body",fill:"white","ref-x":.5,"ref-y":15,"x-alignment":"middle","font-size":"13px","font-family":"Arial"},".tge-question-tools>image":{preserveAspectRatio:"xMidYMid meet"},".tge-remove-tool":{ref:".question-body","ref-x":7,"ref-y":5,filter:{name:"dropShadow",args:{dx:0,dy:0,blur:2}}},".tge-duplicate-tool":{ref:".question-body","ref-dx":-42,"ref-y":5,filter:{name:"dropShadow",args:{dx:0,dy:0,blur:2}}},".tge-edit-tool":{ref:".question-body","ref-dx":-20,"ref-y":5,filter:{name:"dropShadow",args:{dx:0,dy:0,blur:2}}}},ports:{groups:{in:{position:{name:"top"}},out:{position:{name:"bottom"}}},items:[]}},joint.dia.Element.prototype.defaults),initialize:function(){this.on("change:text",function(a,b,c){this.attr(".question-text/text",this.get_text())}),this.on("change:image",function(){this.attr(".question-image/xlink:href",this.get_image()),this.auto_resize(),this.loadAnswers(),this.attr(".question-text/text",this.get_text())}),this.on("change:q_type",function(){this.trigger("change:answers")}),this.on("change:answers",function(){this.loadAnswers(),this.auto_resize(),this.attr(".question-image/height",this.get("size").height),this.attr(".question-text/text",this.get_text())},this),this.auto_resize(),this.initializePorts(),this.attr(".question-text/text",this.get_text()),this.get("image")&&this.attr(".question-image/xlink:href",this.get_image()),this.attr(".tge-remove-tool/xlink:href",TGE_Editor.icons.delete),this.attr(".tge-edit-tool/xlink:href",TGE_Editor.icons.edit),this.attr(".tge-duplicate-tool/xlink:href",TGE_Editor.icons.duplicate),joint.dia.Element.prototype.initialize.apply(this,arguments)},loadAnswers:function(){var a=-1,b=0,c=_.map(this.getEmbeddedCells(),"id"),d=_.map(this.get("answers"),"id"),e=_.difference(c,d);_.each(e,function(a,b,c){window.tge_app_view.graph.getCell(a).remove()},this);var f=_.sortBy(this.get("answers"),function(a){return parseInt(a.order)});_.each(f,function(c,d,e){d&&d%TGE_Editor.const.answers_per_row==0&&(a=-1,b++),a++,this.loadAnswer(c,a,b)},this)},loadAnswer:function(a,b,c){var d=this.graph.getCell(a.id),e=this.toJSON();if(d)d.set(_.extend({},a,{col:b,row:c,jQuestion:{position:e.position,image:e.image,text_size:e.text_size,q_type:e.q_type}})),d.trigger(2===parseInt(this.get("q_type"))?"change:image":"change:text");else{var f=new joint.shapes.tge.Answer(_.extend(a,{col:b,row:c,jQuestion:{position:e.position,image:e.image,text_size:e.text_size,q_type:e.q_type}}));this.embed(f),this.graph.addCell(f)}},get_image:function(){return null===this.get("image")?"":this.get("image").sizes&&this.get("image").sizes.thumbnail?"string"==typeof this.get("image")?this.get("image"):this.get("image").sizes.thumbnail.url:""},get_text:function(){var a=this.get("size").width;if(a-=2*TGE_Editor.const.answer.margin.left,0===this.get("answers").length&&3!==parseInt(this.get("q_type")))return this.get("text");var b=_.unescape(this.get("text")),c=this.get("text_size");c=joint.util.measureText(b,{fontSize:this.attr(".question-text/font-size")}),this.set("text_size",c),this.get("q_type")&&this.get("image")?(this.attr(".question-text/x-alignment",null),this.attr(".question-text/ref-x",null),this.attr(".question-text/x",120),a-=105):(this.attr(".question-text/x-alignment","middle"),this.attr(".question-text/ref-x",.5),this.attr(".question-text/x",null));var d,e=c.width<a;for(e||(a-=10,d="...");!e;)b=b.slice(0,b.length-1),c=joint.util.measureText(b,{fontSize:this.attr(".question-text/font-size")}),e=c.width<a;return d?b+d:b},initializePorts:function(){var a={".port-body":{magnet:!0,stroke:"white","stroke-width":1,qid:this.get("id")}};this.get("ports").items.push({id:"q-in-port-"+this.get("id"),group:"in",attrs:a}),this.get("ports").items.push({id:"q-out-port-"+this.get("id"),group:"out",attrs:a})},auto_resize:function(){var a=this._calculate_width(),b=this._calculate_height();b+=TGE_Editor.const.question.size.height,this.attr(".question-body/width",a),this.attr(".question-body/height",b),this.attr(".question-image/height",b),this.resize(a,b)},_calculate_width:function(){var a=this.get("answers").length,b=TGE_Editor.const.answers_per_row,c=TGE_Editor.const.answer.margin.left,d=2===parseInt(this.get("q_type"))?TGE_Editor.const.answer.image.size.width:TGE_Editor.const.answer.size.width,e=a*d+c*(a+1);return a>=b&&(e=b*d+c*(b+1)),this.get("image")&&(e+=TGE_Editor.const.question.image.size.width),e||1},_calculate_height:function(){var a=this.get("answers").length,b=Math.ceil(a/TGE_Editor.const.answers_per_row);return b*(2===parseInt(this.get("q_type"))?TGE_Editor.const.answer.image.size.height:TGE_Editor.const.answer.size.height)+b*TGE_Editor.const.answer.margin.bottom+25||1},save:function(){new TGE_Editor.models.Question(this.toJSON()).save()}}),joint.shapes.tge.QuestionView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments)},render:function(){joint.dia.ElementView.prototype.render.apply(this,arguments),this.renderTools(),this.update()},renderTools:function(){var a=this.model.toolsMarkup||this.model.get("toolsMarkup");if(a){var b=V(a);V(this.el).append(b)}},pointerclick:function(a){if("tge-remove-tool"===a.target.getAttribute("class")&&TVE_Dash.modal(TGE_Editor.modals.DeleteQuestion,{model:this.model}),"tge-duplicate-tool"===a.target.getAttribute("class"))return this.duplicate_question();if("tge-edit-tool"===a.target.getAttribute("class")){var b=window.tge_app_view.questions.findWhere({id:this.model.id});b.get("answers").sort(),TVE_Dash.modal(TGE_Editor.modals.EditQuestion,{model:b,dismissible:!1,"max-width":"40%"})}joint.dia.ElementView.prototype.pointerclick.apply(this,arguments)},duplicate_question:function(){var a=window.tge_app_view.questions.findWhere({id:this.model.id});if(a instanceof Backbone.Model){var b=new TGE_Editor.models.Question(a.toDeepJSON());b.clear_for_duplicate(),window.tge_app_view.saving(),TVE_Dash.showLoader(),b.save(null,{success:function(a,c,d){window.tge_app_view.questions.add(b),window.opener&&window.opener.postMessage({event:"tqb_question_counter_update",number:window.tge_app_view.questions.length},"*")},error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){TVE_Dash.hideLoader(),window.tge_app_view.change_automatically_saved()}})}}}),joint.shapes.tge.Answer=joint.dia.Element.extend({markup:'<g class="rotatable"><g class="scalable"><rect class="body"/></g><image/><text class="answer-text"/><g class="text-icon" fill="white"><path d="M13.085 0l-1 1H0V0h13.085zm-4 4l-1 1H0V4h9.085zM0 9V8h5v1H0zm0 4v-1h5v1H0zM12.332 9.934v.003l4.295-4.323-2.24-2.241-4.324 4.295h.003L8.671 9.044l.006.002-.31 1.869.718.717 1.869-.308.464-.467v-.004l.914-.92zm7.15-8.065c.691.691.685 1.772.016 2.44l-8.006 8.059-3.783.624a.61.61 0 0 1-.7-.7l.623-3.784L15.691.502c.67-.67 1.754-.67 2.424 0l1.367 1.367zm-.774 1.65c.236-.236.235-.609-.016-.86l-1.367-1.367a.596.596 0 0 0-.844 0l-.001.001-.002.002-1.227 1.219 2.235 2.235 1.22-1.227V3.52h.002z"/></g></g>',portMarkup:'<circle class="port-body" r="6" fill="gray" />',defaults:joint.util.deepSupplement({type:"tge.Answer",attrs:{".":{magnet:!1},".body":{width:TGE_Editor.const.answer.size.width,height:TGE_Editor.const.answer.size.height,rx:"3px",ry:"3px",fill:"#797e84"},image:{width:TGE_Editor.const.answer.image.size.width,height:TGE_Editor.const.answer.image.size.height,preserveAspectRatio:"xMidYMid slice"},text:{ref:"rect","ref-x":.5,"ref-y":.5,"y-alignment":"middle","x-alignment":"middle",fill:"white","font-size":"11px",filter:{name:"dropShadow",args:{blur:1,opacity:1,color:"black"}}},".text-icon":{display:"none",ref:"rect","ref-x":.5,"ref-y":.5,"x-alignment":"middle","y-alignment":"middle",filter:{name:"dropShadow",args:{blur:1,opacity:1,color:"black"}}}},ports:{groups:{out:{position:{name:"bottom"}}},items:[]}},joint.dia.Element.prototype.defaults),initialize:function(){this.on("change:text",function(){this.attr(".answer-text/text",this.get_text()),this.attr("image/xlink:href",null),this.auto_resize(),this.auto_position(),this.toggle_port(),this.toggle_text_icon()}),this.on("change:image",function(){this.attr("image/xlink:href",this.get_image()),this.attr(".answer-text/text",this.get_text()),this.auto_resize(),this.auto_position(),this.toggle_port(),this.toggle_text_icon()}),this.on("change:is_right",function(){this.style_right_wrong(),this.auto_resize(),this.auto_position()}),this.get("image")&&2===parseInt(this.get("jQuestion").q_type)&&this.attr("image/xlink:href",this.get_image()),this.style_right_wrong(),this.attr(".answer-text/text",this.get_text()),this.toggle_text_icon(),this.auto_position(),this.auto_resize(),this.initializePorts(),joint.dia.Element.prototype.initialize.apply(this,arguments)},initializePorts:function(){if(3===parseInt(this.get("jQuestion").q_type))return this;this.get("ports").items.push(this.port_definition())},port_definition:function(){var a={".port-body":{magnet:!0,stroke:"#393d44","stroke-width":1,aid:this.get("id")}};return{id:"a-port-"+this.get("id"),group:"out",attrs:a}},auto_resize:function(){var a=2==this.get("jQuestion").q_type?TGE_Editor.const.answer.image.size.width:TGE_Editor.const.answer.size.width,b=2==this.get("jQuestion").q_type?TGE_Editor.const.answer.image.size.height:TGE_Editor.const.answer.size.height;this.attr(".body/width",a),this.attr(".body/height",b),this.get("image")&&2==this.get("jQuestion").q_type?(this.attr("image/width",TGE_Editor.const.answer.image.size.width),this.attr("image/height",TGE_Editor.const.answer.image.size.height)):(this.attr("image/width",0),this.attr("image/height",0)),this.resize(a,b)},auto_position:function(){var a=this.get("jQuestion").position.x,b=this.get("jQuestion").position.y,c=this.get("jQuestion").image,d=this.get("jQuestion").text_size,e=2==this.get("jQuestion").q_type?TGE_Editor.const.answer.image.size.width:TGE_Editor.const.answer.size.width,f=2==this.get("jQuestion").q_type?TGE_Editor.const.answer.image.size.height:TGE_Editor.const.answer.size.height,g=this.get("col"),h=this.get("row");b+=Math.round(d.height)+25,a+=TGE_Editor.const.answer.margin.left*(g?g+1:1)+g*e,b+=f*h+TGE_Editor.const.answer.margin.bottom*h,c&&(a+=TGE_Editor.const.question.image.size.width),this.set("position",{x:a,y:b})},get_image:function(){return null===this.get("image")?"":"string"==typeof this.get("image")?this.get("image"):this.get("image")instanceof Backbone.Model?this.get("image").get("sizes").thumbnail.url:this.get("image").sizes.thumbnail.url},get_text:function(){if(2===parseInt(this.get("jQuestion").q_type))return this.get("points")+"p";if(3===parseInt(this.get("jQuestion").q_type))return"";var a=this.get("points")+"p - "+_.unescape(this.get("text"));return a.length<=24?a:a.slice(0,24)+"..."},style_right_wrong:function(){var a=parseInt(this.get("jQuestion").q_type),b=1===parseInt(this.get("is_right")),c=3===parseInt(this.get("jQuestion").q_type),d=2!==a?2:4;this.attr(".body/stroke",b?"#62c343":"red"),this.attr(".body/stroke-width",b&&!1===c?d:"0")},toggle_text_icon:function(){this.attr(".text-icon",{display:3===parseInt(this.get("jQuestion").q_type)?"block":"none"})},toggle_port:function(){return 3===parseInt(this.get("jQuestion").q_type)?this.removePort(this.port_definition().id):(!1===this.hasPort(this.port_definition().id)&&this.addPort(this.port_definition()),this)}}),joint.shapes.tge.StartFlow=joint.dia.Element.extend({markup:'<g class="rotatable" style="cursor: pointer"><g class="scalable"><rect class="body"/></g><text/><g><g class="video-icon"><circle class="bg-video-icon" r="9" fill="white" transform="translate(20,19)"></circle><path class="path1" d="M16 0c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16-7.163-16-16-16zM16 29c-7.18 0-13-5.82-13-13s5.82-13 13-13 13 5.82 13 13-5.82 13-13 13zM12 9l12 7-12 7z"></path></g></g></g>',portMarkup:'<circle class="port-body" r="7" fill="gray" />',defaults:joint.util.deepSupplement({type:"tge.StartFlow",size:{width:130,height:40},ports:{groups:{out:{position:{name:"bottom"}}},items:[]},attrs:{".":{magnet:!1},".body":{width:130,height:40,fill:"white",rx:3,ry:3,stroke:"#595c60","stroke-width":.5},".path1":{fill:"#87548d",transform:"translate(9,8),scale(0.7)"},text:{ref:".body",x:40,"ref-y":.5,"y-alignment":"middle","font-family":"Arial","font-size":"16px","font-weight":"bold",text:TGE_Editor.t.quiz_start,fill:"#87548d"}}},joint.dia.Element.prototype.defaults),initialize:function(){this.initializePorts(),joint.dia.Element.prototype.initialize.apply(this,arguments)},initializePorts:function(){var a={".port-body":{magnet:!0,stroke:"white",fill:"#87548d","stroke-width":2}};this.get("ports").items.push({id:"start-port",group:"out",attrs:a})}}),joint.shapes.tge.StartFlowView=joint.dia.ElementView.extend({pointerclick:function(a){if($(a.target).is("path")||$(a.target).is(".bg-video-icon"))return void TGE_Editor.wistia.start_quiz.play();var b={x:100+tge_app_view.$el.scrollLeft(),y:100},c=new TGE_Editor.models.Question({text:"question",position:b});TVE_Dash.modal(TGE_Editor.modals.AddQuestion,{model:c,dismissible:!1,"max-width":"40%"}),joint.dia.ElementView.prototype.pointerclick.apply(this,arguments)}}),joint.util.measureText=function(a,b){var c=parseInt(b.fontSize,10)||10,d=V("svg").node,e=V("<text><tspan></tspan></text>").node,f=e.firstChild,g=document.createTextNode("");f.setAttribute("font-size",b.fontSize),f.appendChild(g),d.appendChild(e),document.body.appendChild(d);var h=a.split("\n"),i=0;_.each(h,function(a){g.data=a;var b=f.getComputedTextLength();i=Math.max(i,b)});var j=h.length*(1.2*c);return V(d).remove(),{width:i,height:j}};var tgeLink=joint.dia.Link.extend({arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<path class="marker-arrowhead" d="M 10 0 L 0 5 L 10 10 z" />',"</g>"].join(""),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="9" />','<path transform="scale(.6) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z" />',"<title>Remove link.</title>","</g>",'<g class="tool-options" event="link:options">','<circle r="11" transform="translate(25)"/>','<path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/>',"<title>Link options.</title>","</g>","</g>"].join("")}),TGE_Editor=TGE_Editor||{};TGE_Editor.views=TGE_Editor.views||{},function(a){a(function(){var b=a("html");a("html").css({height:window.innerHeight-parseInt(b.css("margin-top"))-4}),window.tge_app_view=new TGE_Editor.views.AppView,TGE_Editor.wistia={},window._wq=window._wq||[],_wq.push({id:"f6sh0ulno2",onReady:function(a){TGE_Editor.wistia.start_quiz=a}})})}(jQuery);